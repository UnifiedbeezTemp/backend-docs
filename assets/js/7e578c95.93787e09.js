"use strict";(globalThis.webpackChunkbackend_docs=globalThis.webpackChunkbackend_docs||[]).push([[1502],{6187:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"apple-integration","title":"Apple Sign In Integration Guide","description":"Overview","source":"@site/docs/apple-integration.md","sourceDirName":".","slug":"/apple-integration","permalink":"/backend-docs/docs/apple-integration","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/apple-integration.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Addon System - Frontend Integration Guide","permalink":"/backend-docs/docs/addon-integration"},"next":{"title":"Automations \u2014 Frontend Integration Guide","permalink":"/backend-docs/docs/automations/"}}');var i=t(4848),s=t(8453);const o={},a="Apple Sign In Integration Guide",l={},d=[{value:"Overview",id:"overview",level:2},{value:"Frontend Implementation",id:"frontend-implementation",level:2},{value:"1. Install Apple JS SDK",id:"1-install-apple-js-sdk",level:3},{value:"2. Configuration",id:"2-configuration",level:3},{value:"3. Sign In Component",id:"3-sign-in-component",level:3},{value:"4. Callback Handler Page",id:"4-callback-handler-page",level:3},{value:"5. Usage",id:"5-usage",level:3},{value:"Flow Diagram",id:"flow-diagram",level:2},{value:"Session Management",id:"session-management",level:2},{value:"Custom Redirect Paths",id:"custom-redirect-paths",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Why Mode Parameter?",id:"why-mode-parameter",level:2},{value:"Apple Developer Console Setup",id:"apple-developer-console-setup",level:2},{value:"Security Notes",id:"security-notes",level:2},{value:"Common Issues",id:"common-issues",level:2},{value:"&quot;User not found&quot; on signup retry",id:"user-not-found-on-signup-retry",level:3},{value:"Redirect to wrong URL after auth",id:"redirect-to-wrong-url-after-auth",level:3},{value:"Cookie not being set",id:"cookie-not-being-set",level:3}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"apple-sign-in-integration-guide",children:"Apple Sign In Integration Guide"})}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(n.p,{children:["Apple Sign In uses OAuth2 authorization code flow with server-side token exchange and redirect-based authentication. The flow explicitly distinguishes between signup and login via the ",(0,i.jsx)(n.code,{children:"state"})," parameter, ensuring proper handling even when Apple doesn't return user information on subsequent attempts."]}),"\n",(0,i.jsx)(n.h2,{id:"frontend-implementation",children:"Frontend Implementation"}),"\n",(0,i.jsx)(n.h3,{id:"1-install-apple-js-sdk",children:"1. Install Apple JS SDK"}),"\n",(0,i.jsxs)(n.p,{children:["Add to your HTML ",(0,i.jsx)(n.code,{children:"<head>"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-html",children:'<script\n  type="text/javascript"\n  src="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"\n><\/script>\n'})}),"\n",(0,i.jsx)(n.h3,{id:"2-configuration",children:"2. Configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'// config/appleAuth.ts\nexport const appleAuthConfig = {\n  clientId: import.meta.env.VITE_APPLE_CLIENT_ID,\n  redirectURI: import.meta.env.VITE_APPLE_REDIRECT_URI, // Backend callback URL\n  scope: "name email",\n  getState: (\n    redirectPath: string = "/auth/callback",\n    mode: "signup" | "login"\n  ) => {\n    // Encode full frontend redirect URL and auth mode in state\n    const fullRedirectUrl = `${window.location.origin}${redirectPath}`;\n    return btoa(\n      JSON.stringify({\n        redirect_url: fullRedirectUrl,\n        mode: mode, // Explicitly specify signup or login\n      })\n    );\n  },\n};\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Environment Variables:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-env",children:"VITE_APPLE_CLIENT_ID=com.yourcompany.yourapp.service\nVITE_APPLE_REDIRECT_URI=https://api.yourdomain.com/api/v1/auth/apple/callback\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-sign-in-component",children:"3. Sign In Component"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'import React, { useEffect } from "react";\nimport { appleAuthConfig } from "../config/appleAuth";\n\ninterface AppleAuthProps {\n  mode: "signup" | "login";\n  redirectPath?: string; // Optional custom redirect after auth\n}\n\ndeclare global {\n  interface Window {\n    AppleID: any;\n  }\n}\n\nexport const AppleAuth: React.FC<AppleAuthProps> = ({\n  mode,\n  redirectPath = "/auth/callback",\n}) => {\n  useEffect(() => {\n    const script = document.createElement("script");\n    script.src =\n      "https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js";\n    script.async = true;\n    script.onload = () => {\n      if (window.AppleID) {\n        window.AppleID.auth.init({\n          clientId: appleAuthConfig.clientId,\n          scope: appleAuthConfig.scope,\n          redirectURI: appleAuthConfig.redirectURI,\n          state: appleAuthConfig.getState(redirectPath, mode), // Pass mode explicitly\n          usePopup: false,\n        });\n      }\n    };\n    document.head.appendChild(script);\n\n    return () => {\n      if (document.head.contains(script)) {\n        document.head.removeChild(script);\n      }\n    };\n  }, [redirectPath, mode]); // Add mode to dependencies\n\n  const handleAppleAuth = async () => {\n    try {\n      if (!window.AppleID) {\n        throw new Error("Apple ID SDK not loaded");\n      }\n\n      // Redirects to Apple, then to backend callback, then to frontend\n      await window.AppleID.auth.signIn();\n    } catch (error) {\n      console.error("Apple auth error:", error);\n    }\n  };\n\n  return (\n    <button\n      onClick={handleAppleAuth}\n      className="apple-auth-btn"\n      style={{\n        backgroundColor: "#000",\n        color: "white",\n        border: "none",\n        padding: "12px 24px",\n        borderRadius: "4px",\n        cursor: "pointer",\n        fontSize: "14px",\n        fontWeight: "600",\n        width: "100%",\n      }}\n    >\n      {mode === "signup" ? "Sign up" : "Sign in"} with Apple\n    </button>\n  );\n};\n'})}),"\n",(0,i.jsx)(n.h3,{id:"4-callback-handler-page",children:"4. Callback Handler Page"}),"\n",(0,i.jsxs)(n.p,{children:["Create ",(0,i.jsx)(n.code,{children:"/auth/callback"})," route:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'// pages/AuthCallback.tsx\nimport React, { useEffect } from "react";\nimport { useNavigate, useSearchParams } from "react-router-dom";\n\nexport const AuthCallback: React.FC = () => {\n  const navigate = useNavigate();\n  const [searchParams] = useSearchParams();\n\n  useEffect(() => {\n    const success = searchParams.get("success");\n    const error = searchParams.get("error");\n\n    if (success) {\n      // Auth successful, session cookie set by backend\n      navigate("/dashboard");\n    } else if (error) {\n      console.error("Auth error:", error);\n      navigate("/login?error=" + encodeURIComponent(error));\n    }\n  }, [searchParams, navigate]);\n\n  return (\n    <div style={{ textAlign: "center", marginTop: "50px" }}>\n      <p>Processing authentication...</p>\n    </div>\n  );\n};\n'})}),"\n",(0,i.jsx)(n.h3,{id:"5-usage",children:"5. Usage"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'// In your login/signup page\nimport { AppleAuth } from "../components/AppleAuth";\n\nfunction LoginPage() {\n  return (\n    <div>\n      <h1>Login</h1>\n      <AppleAuth mode="login" redirectPath="/dashboard" />\n    </div>\n  );\n}\n\nfunction SignupPage() {\n  return (\n    <div>\n      <h1>Sign Up</h1>\n      <AppleAuth mode="signup" redirectPath="/onboarding" />\n    </div>\n  );\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"flow-diagram",children:"Flow Diagram"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"1. User clicks \"Sign in with Apple\" (mode: signup or login)\n   \u2193\n2. Frontend calls AppleID.auth.signIn() with state containing:\n   - redirect_url: Full frontend callback URL\n   - mode: 'signup' or 'login'\n   \u2193\n3. Redirects to Apple's auth page\n   \u2193\n4. User authenticates with Apple\n   \u2193\n5. Apple redirects to backend: POST /api/v1/auth/apple/callback\n   \u2193\n6. Backend:\n   - Parses state to extract mode and redirect URL\n   - Validates origin (*.unifiedbeez.com)\n   - Uses mode from state (not body.user) to determine flow\n   - Exchanges code for tokens\n   - Calls authService.socialSignup() or socialLogin() based on mode\n   - Creates session\n   - Sets httpOnly cookie\n   \u2193\n7. Backend redirects to frontend URL from state: {origin}{redirectPath}?success=true\n   \u2193\n8. Frontend callback page handles success/error\n   \u2193\n9. Navigate to dashboard (session cookie already set)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"session-management",children:"Session Management"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Session managed via ",(0,i.jsx)(n.strong,{children:"httpOnly cookie"})," (set by backend)"]}),"\n",(0,i.jsx)(n.li,{children:"No tokens exposed to frontend"}),"\n",(0,i.jsx)(n.li,{children:"Cookie automatically sent with API requests"}),"\n",(0,i.jsxs)(n.li,{children:["Cookie settings: ",(0,i.jsx)(n.code,{children:"httpOnly"}),", ",(0,i.jsx)(n.code,{children:"secure"}),", ",(0,i.jsx)(n.code,{children:"sameSite=none"})]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"custom-redirect-paths",children:"Custom Redirect Paths"}),"\n",(0,i.jsx)(n.p,{children:"Frontend can specify where to redirect after auth:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'// Redirect to onboarding after signup\n<AppleAuth mode="signup" redirectPath="/onboarding" />\n\n// Redirect to dashboard after login\n<AppleAuth mode="login" redirectPath="/dashboard" />\n\n// Default: /auth/callback\n<AppleAuth mode="login" />\n'})}),"\n",(0,i.jsx)(n.p,{children:"Backend extracts and validates the full URL from state parameter."}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(n.p,{children:"Backend redirects to callback with error query param:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"/auth/callback?error=Authentication%20failed\n"})}),"\n",(0,i.jsx)(n.p,{children:"Handle in callback page and show appropriate message."}),"\n",(0,i.jsx)(n.h2,{id:"why-mode-parameter",children:"Why Mode Parameter?"}),"\n",(0,i.jsxs)(n.p,{children:["Apple's behavior with the ",(0,i.jsx)(n.code,{children:"user"})," object is inconsistent:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"First signup attempt"}),": Apple sends ",(0,i.jsx)(n.code,{children:"body.user"})," with name/email"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Retry after error"}),": Apple doesn't send ",(0,i.jsx)(n.code,{children:"body.user"})," (user already authorized the app)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Subsequent logins"}),": Apple never sends ",(0,i.jsx)(n.code,{children:"body.user"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["By explicitly passing ",(0,i.jsx)(n.code,{children:"mode"})," in the state parameter, the backend always knows the user's intent regardless of Apple's behavior. This prevents the \"User not found\" error when a signup attempt fails and the user retries."]}),"\n",(0,i.jsx)(n.h2,{id:"apple-developer-console-setup",children:"Apple Developer Console Setup"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"App ID"})," - Enable Sign in with Apple capability"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Services ID"})," - Create with your client ID"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Return URLs"})," - Add backend callback URL (e.g., ",(0,i.jsx)(n.code,{children:"https://api.yourdomain.com/api/v1/auth/apple/callback"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Domain verification"})," - Verify your domain"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Private Key"})," - Create for token signing (backend uses this)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"security-notes",children:"Security Notes"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Backend validates redirect URLs against allowed origins (",(0,i.jsx)(n.code,{children:"*.unifiedbeez.com"}),", localhost)"]}),"\n",(0,i.jsx)(n.li,{children:"State parameter base64-encoded to pass redirect URL and mode safely"}),"\n",(0,i.jsx)(n.li,{children:"Open redirect attacks prevented by origin validation"}),"\n",(0,i.jsxs)(n.li,{children:["Mode extracted from state (controlled by frontend) instead of unreliable ",(0,i.jsx)(n.code,{children:"body.user"})]}),"\n",(0,i.jsx)(n.li,{children:"First-time users: Apple returns user name"}),"\n",(0,i.jsx)(n.li,{children:"Subsequent logins: Only email in ID token"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"common-issues",children:"Common Issues"}),"\n",(0,i.jsx)(n.h3,{id:"user-not-found-on-signup-retry",children:'"User not found" on signup retry'}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Solution"}),": The mode parameter in state ensures backend knows it's a signup attempt, even when Apple doesn't send ",(0,i.jsx)(n.code,{children:"body.user"})," on retry."]}),"\n",(0,i.jsx)(n.h3,{id:"redirect-to-wrong-url-after-auth",children:"Redirect to wrong URL after auth"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Solution"}),": Ensure ",(0,i.jsx)(n.code,{children:"redirectPath"})," is correctly set in ",(0,i.jsx)(n.code,{children:"<AppleAuth>"})," component and backend validates the full URL from state."]}),"\n",(0,i.jsx)(n.h3,{id:"cookie-not-being-set",children:"Cookie not being set"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Solution"}),": Check backend cookie settings include ",(0,i.jsx)(n.code,{children:"secure: true"})," and ",(0,i.jsx)(n.code,{children:"sameSite: 'none'"})," for cross-origin requests."]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var r=t(6540);const i={},s=r.createContext(i);function o(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);