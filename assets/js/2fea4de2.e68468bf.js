"use strict";(globalThis.webpackChunkbackend_docs=globalThis.webpackChunkbackend_docs||[]).push([[4860],{2180:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"frontend-billing-integration","title":"Frontend Billing Integration Guide","description":"This document covers everything the frontend needs to implement trial setup, subscription billing, yearly billing, and payment method management.","source":"@site/docs/frontend-billing-integration.md","sourceDirName":".","slug":"/frontend-billing-integration","permalink":"/backend-docs/docs/frontend-billing-integration","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/frontend-billing-integration.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Apple Sign In Integration Guide","permalink":"/backend-docs/docs/apple-integration"}}');var i=t(4848),s=t(8453);const l={},a="Frontend Billing Integration Guide",d={},c=[{value:"Overview",id:"overview",level:2},{value:"Billing Intervals",id:"billing-intervals",level:2},{value:"Setup",id:"setup",level:2},{value:"Reading the User&#39;s Payment State",id:"reading-the-users-payment-state",level:2},{value:"Flow 1: Trial Setup (New Users)",id:"flow-1-trial-setup-new-users",level:2},{value:"Step 1 \u2014 Select plan and billing interval, call <code>confirmTrial</code>",id:"step-1--select-plan-and-billing-interval-call-confirmtrial",level:3},{value:"Step 2 \u2014 Collect card with Stripe Elements",id:"step-2--collect-card-with-stripe-elements",level:3},{value:"Step 3 \u2014 Attach the payment method",id:"step-3--attach-the-payment-method",level:3},{value:"Flow 2: Updating a Saved Card (Existing Users)",id:"flow-2-updating-a-saved-card-existing-users",level:2},{value:"Step 1 \u2014 Create a new SetupIntent",id:"step-1--create-a-new-setupintent",level:3},{value:"Step 2 \u2014 Collect the new card with Stripe Elements",id:"step-2--collect-the-new-card-with-stripe-elements",level:3},{value:"Step 3 \u2014 Save the updated card",id:"step-3--save-the-updated-card",level:3},{value:"Flow 3: Switching Billing Interval (Monthly \u2192 Yearly)",id:"flow-3-switching-billing-interval-monthly--yearly",level:2},{value:"Yearly \u2192 Monthly",id:"yearly--monthly",level:3},{value:"Other Billing Endpoints",id:"other-billing-endpoints",level:2},{value:"Subscription status",id:"subscription-status",level:3},{value:"Cancel subscription",id:"cancel-subscription",level:3},{value:"Reactivate subscription",id:"reactivate-subscription",level:3},{value:"Subscription Status Reference",id:"subscription-status-reference",level:2},{value:"Billing Interval UI Patterns",id:"billing-interval-ui-patterns",level:2},{value:"Plan selector with interval toggle",id:"plan-selector-with-interval-toggle",level:3},{value:"Pending yearly switch banner",id:"pending-yearly-switch-banner",level:3},{value:"Block monthly option for yearly users",id:"block-monthly-option-for-yearly-users",level:3},{value:"Displaying Card Brand",id:"displaying-card-brand",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Reference: Complete Flow Diagram",id:"reference-complete-flow-diagram",level:2},{value:"Reference Component",id:"reference-component",level:2}];function o(e){const n={blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"frontend-billing-integration-guide",children:"Frontend Billing Integration Guide"})}),"\n",(0,i.jsx)(n.p,{children:"This document covers everything the frontend needs to implement trial setup, subscription billing, yearly billing, and payment method management."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"Billing is built on Stripe. The backend owns all Stripe logic \u2014 the frontend only interacts with two things:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Stripe.js / Stripe Elements"})," \u2014 to securely collect card details in the browser (card numbers never touch your servers)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Backend API endpoints"})," \u2014 to set up intents, attach/update cards, and read billing state"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"There are two distinct flows:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Flow"}),(0,i.jsx)(n.th,{children:"When"}),(0,i.jsx)(n.th,{children:"Endpoints"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Trial setup"})}),(0,i.jsx)(n.td,{children:"New user, no card on file"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"POST /auth/setup/trial"})," \u2192 ",(0,i.jsx)(n.em,{children:"(Stripe Elements)"})," \u2192 ",(0,i.jsx)(n.code,{children:"POST /auth/payment/attach"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Card update"})}),(0,i.jsx)(n.td,{children:"Existing user changing saved card"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"POST /payment/create-setup-intent"})," \u2192 ",(0,i.jsx)(n.em,{children:"(Stripe Elements)"})," \u2192 ",(0,i.jsx)(n.code,{children:"POST /payment/update-payment-method"})]})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"billing-intervals",children:"Billing Intervals"}),"\n",(0,i.jsxs)(n.p,{children:["Every plan and addon supports ",(0,i.jsx)(n.strong,{children:"monthly"})," and ",(0,i.jsx)(n.strong,{children:"yearly"})," billing. Yearly billing is charged as a single upfront payment for the full year."]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Plan"}),(0,i.jsx)(n.th,{children:"Monthly"}),(0,i.jsx)(n.th,{children:"Yearly"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Individual"}),(0,i.jsx)(n.td,{children:"\xa319/mo"}),(0,i.jsx)(n.td,{children:"\xa3190/yr"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Business"}),(0,i.jsx)(n.td,{children:"\xa399/mo"}),(0,i.jsx)(n.td,{children:"\xa31,000/yr"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Premium"}),(0,i.jsx)(n.td,{children:"\xa3299/mo"}),(0,i.jsx)(n.td,{children:"\xa33,050/yr"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Organisation"}),(0,i.jsx)(n.td,{children:"\xa3499/mo"}),(0,i.jsx)(n.td,{children:"\xa35,090/yr"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Key rules:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Addons inherit the user's billing interval \u2014 a yearly-plan user pays yearly prices for all addons (monthly \xd7 12, no additional discount)."}),"\n",(0,i.jsxs)(n.li,{children:["Yearly \u2192 Monthly downgrade is ",(0,i.jsx)(n.strong,{children:"blocked"})," while on a yearly plan. The user must wait until their yearly period ends."]}),"\n",(0,i.jsx)(n.li,{children:"Monthly \u2192 Yearly switch on an active subscription schedules the switch: the monthly plan runs to the end of its current period, then the yearly subscription starts automatically."}),"\n",(0,i.jsx)(n.li,{children:"Trial plans can be started on either interval. The 30-day trial behaviour is the same regardless."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"billingInterval"})," field is optional on all endpoints and defaults to ",(0,i.jsx)(n.code,{children:"MONTHLY"})," if omitted."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'type BillingInterval = "MONTHLY" | "YEARLY";\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,i.jsx)(n.p,{children:"Install Stripe.js:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm install @stripe/stripe-js @stripe/react-stripe-js\n"})}),"\n",(0,i.jsx)(n.p,{children:"Initialise the Stripe instance once at the top of your app (outside any component so it's not re-created on renders):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'import { loadStripe } from "@stripe/stripe-js";\n\nconst stripePromise = loadStripe(\n  process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY\n);\n'})}),"\n",(0,i.jsx)(n.p,{children:"The publishable key can also be fetched from the backend:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'GET /payment/config\n\u2192 { publishableKey: "pk_live_..." }\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"reading-the-users-payment-state",children:"Reading the User's Payment State"}),"\n",(0,i.jsxs)(n.p,{children:["The user profile (returned on login, signup, and ",(0,i.jsx)(n.code,{children:"GET /auth/profile"}),") includes a ",(0,i.jsx)(n.code,{children:"paymentMethod"})," field and a ",(0,i.jsx)(n.code,{children:"planBillingInterval"})," field:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// Returned when a card is saved\npaymentMethod: {\n  last4: "4242",\n  brand: "visa",        // "visa" | "mastercard" | "amex" | "discover" | etc.\n  expMonth: 12,\n  expYear: 2027,\n} | null                // null = no card on file\n\n// Current billing interval for the user\'s plan\nplanBillingInterval: "MONTHLY" | "YEARLY"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Use this to decide which UI to render:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'if (user.paymentMethod === null) {\n  // Show trial setup / add card prompt\n} else {\n  // Show saved card + "Change card" option\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"You can also fetch card details independently at any time:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GET /payment/payment-method\nAuthorization: (session cookie)\n\n\u2192 { last4, brand, expMonth, expYear } | null\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"flow-1-trial-setup-new-users",children:"Flow 1: Trial Setup (New Users)"}),"\n",(0,i.jsx)(n.p,{children:"This flow runs when a user has no card on file and wants to start their 30-day trial."}),"\n",(0,i.jsxs)(n.h3,{id:"step-1--select-plan-and-billing-interval-call-confirmtrial",children:["Step 1 \u2014 Select plan and billing interval, call ",(0,i.jsx)(n.code,{children:"confirmTrial"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'POST /auth/setup/trial\nContent-Type: application/json\n\n{\n  "planType": "BUSINESS",        // "INDIVIDUAL" | "BUSINESS" | "PREMIUM" | "ORGANISATION"\n  "billingInterval": "YEARLY"    // optional, defaults to "MONTHLY"\n}\n\n\u2192 {\n    "message": "Trial setup initiated",\n    "trialEndsAt": "2025-03-26T10:00:00.000Z",\n    "clientSecret": "seti_..._secret_...",\n    "customerId": "cus_..."\n  }\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Store ",(0,i.jsx)(n.code,{children:"clientSecret"})," and ",(0,i.jsx)(n.code,{children:"trialEndsAt"})," \u2014 you'll need them in the next step."]}),"\n",(0,i.jsx)(n.h3,{id:"step-2--collect-card-with-stripe-elements",children:"Step 2 \u2014 Collect card with Stripe Elements"}),"\n",(0,i.jsxs)(n.p,{children:["Wrap the card form in an ",(0,i.jsx)(n.code,{children:"<Elements>"})," provider and use the ",(0,i.jsx)(n.code,{children:"clientSecret"})," from step 1:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:'import {\n  Elements,\n  CardElement,\n  useStripe,\n  useElements,\n} from "@stripe/react-stripe-js";\n\n// In your component tree:\n<Elements stripe={stripePromise}>\n  <CardForm clientSecret={clientSecret} />\n</Elements>;\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Inside the form, call ",(0,i.jsx)(n.code,{children:"stripe.confirmCardSetup"})," when the user submits:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const { error, setupIntent } = await stripe.confirmCardSetup(clientSecret, {\n  payment_method: { card: elements.getElement(CardElement) },\n});\n\nif (error) {\n  // Show error.message to the user\n  return;\n}\n\nconst paymentMethodId =\n  typeof setupIntent.payment_method === "string"\n    ? setupIntent.payment_method\n    : setupIntent.payment_method.id;\n'})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Important:"})," ",(0,i.jsx)(n.code,{children:"confirmCardSetup"})," contacts Stripe directly. No card data touches your backend."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"step-3--attach-the-payment-method",children:"Step 3 \u2014 Attach the payment method"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'POST /auth/payment/attach\nContent-Type: application/json\n\n{ "payment_method_id": "pm_..." }\n\n\u2192 {\n    "message": "Payment method attached successfully",\n    "paymentMethod": {\n      "last4": "4242",\n      "brand": "visa",\n      "expMonth": 12,\n      "expYear": 2027\n    }\n  }\n'})}),"\n",(0,i.jsx)(n.p,{children:"This call:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Attaches the card to the Stripe customer"}),"\n",(0,i.jsx)(n.li,{children:"Sets it as the default payment method for future charges"}),"\n",(0,i.jsx)(n.li,{children:"Stores card details in the database"}),"\n",(0,i.jsx)(n.li,{children:"Creates the 30-day trial subscription automatically (on the selected billing interval)"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["After this succeeds, update the user's local state with ",(0,i.jsx)(n.code,{children:"paymentMethod"})," from the response and show a success screen."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"flow-2-updating-a-saved-card-existing-users",children:"Flow 2: Updating a Saved Card (Existing Users)"}),"\n",(0,i.jsx)(n.p,{children:"Use this when a user wants to change the card that gets charged."}),"\n",(0,i.jsx)(n.h3,{id:"step-1--create-a-new-setupintent",children:"Step 1 \u2014 Create a new SetupIntent"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'POST /payment/create-setup-intent\n(no body required)\n\n\u2192 {\n    "client_secret": "seti_..._secret_...",\n    "customer_id": "cus_..."\n  }\n'})}),"\n",(0,i.jsx)(n.h3,{id:"step-2--collect-the-new-card-with-stripe-elements",children:"Step 2 \u2014 Collect the new card with Stripe Elements"}),"\n",(0,i.jsxs)(n.p,{children:["Same as trial setup \u2014 use ",(0,i.jsx)(n.code,{children:"stripe.confirmCardSetup"})," with the new ",(0,i.jsx)(n.code,{children:"client_secret"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const { error, setupIntent } = await stripe.confirmCardSetup(clientSecret, {\n  payment_method: { card: elements.getElement(CardElement) },\n});\n\nconst paymentMethodId = /* extract from setupIntent as above */;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"step-3--save-the-updated-card",children:"Step 3 \u2014 Save the updated card"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'POST /payment/update-payment-method\nContent-Type: application/json\n\n{ "payment_method_id": "pm_..." }\n\n\u2192 {\n    "last4": "1234",\n    "brand": "mastercard",\n    "expMonth": 8,\n    "expYear": 2026\n  }\n'})}),"\n",(0,i.jsx)(n.p,{children:"This call:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Attaches the new card to the Stripe customer"}),"\n",(0,i.jsx)(n.li,{children:"Updates the customer's default payment method (used for all future charges)"}),"\n",(0,i.jsx)(n.li,{children:"Updates the default on the active subscription"}),"\n",(0,i.jsx)(n.li,{children:"Overwrites the stored card details in the database"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Does not"})," modify the subscription or create a new one"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Update the saved card state in your UI with the response."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"flow-3-switching-billing-interval-monthly--yearly",children:"Flow 3: Switching Billing Interval (Monthly \u2192 Yearly)"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Trial vs active behaviour differs:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Active (paid) monthly user"})," \u2192 switch is ",(0,i.jsx)(n.strong,{children:"scheduled"}),": current monthly period runs to its end, then the yearly subscription starts automatically."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Trial user"})," \u2192 switch is ",(0,i.jsx)(n.strong,{children:"immediate"}),": the monthly trial subscription is cancelled and replaced with a new yearly trial subscription. The remaining trial days are preserved."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Users on an active monthly plan can switch to yearly billing. The switch is scheduled \u2014 the monthly plan continues until the end of its current period, then the yearly subscription starts automatically."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'POST /plan/switch\nContent-Type: application/json\n\n{\n  "planType": "BUSINESS",         // same plan or a new plan\n  "billingInterval": "YEARLY"\n}\n\n\u2192 {\n    "message": "Your plan will switch to yearly billing at the end of your current monthly period.",\n    "pendingSwitch": true\n  }\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"While a pending switch is active:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The user remains on their current monthly subscription until it expires"}),"\n",(0,i.jsxs)(n.li,{children:["A second switch request to the same target will return ",(0,i.jsx)(n.code,{children:"400 SWITCH_ALREADY_PENDING"})]}),"\n",(0,i.jsxs)(n.li,{children:["Show a banner informing the user of the scheduled change and when it takes effect (",(0,i.jsx)(n.code,{children:"subscription.currentPeriodEnd"}),")"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"yearly--monthly",children:"Yearly \u2192 Monthly"}),"\n",(0,i.jsxs)(n.p,{children:["This is ",(0,i.jsx)(n.strong,{children:"blocked"})," while the user is on a yearly plan:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'// 400\n{\n  "error": "YEARLY_DOWNGRADE_NOT_ALLOWED",\n  "message": "You cannot switch to monthly billing while on a yearly plan. Your yearly plan will continue until the end of the current period."\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Do not show a monthly billing option to yearly users. You can check ",(0,i.jsx)(n.code,{children:"user.planBillingInterval"})," to conditionally disable or hide the option."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"other-billing-endpoints",children:"Other Billing Endpoints"}),"\n",(0,i.jsx)(n.h3,{id:"subscription-status",children:"Subscription status"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'GET /payment/subscription-status\n\n\u2192 {\n    "subscription": {\n      "subscriptionId": "sub_...",\n      "status": "trialing",           // "trialing" | "active" | "past_due" | "canceled"\n      "currentPeriodEnd": "2025-03-26T...",\n      "trialEnd": "2025-03-26T...",\n      "billingInterval": "MONTHLY",   // "MONTHLY" | "YEARLY"\n      "cancelAtPeriodEnd": false      // true when cancellation is scheduled at period end\n    },\n    "isOnTrial": true,\n    "trialInfo": {\n      "planType": "BUSINESS",\n      "billingInterval": "MONTHLY"\n    },\n    "gracePeriod": null,\n    "accessRevoked": null\n  }\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"isOnTrial"})," and ",(0,i.jsx)(n.code,{children:"subscription.status"})," to conditionally show trial banners, upgrade prompts, or payment failure notices. Use ",(0,i.jsx)(n.code,{children:"subscription.billingInterval"})," to show the current billing cycle in settings."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Pending cancellation:"})," When ",(0,i.jsx)(n.code,{children:"subscription.cancelAtPeriodEnd === true"}),", the subscription is scheduled to cancel at the end of the current period (",(0,i.jsx)(n.code,{children:"currentPeriodEnd"}),"). The user retains access until then."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:'status === "trialing"'})," and ",(0,i.jsx)(n.code,{children:"cancelAtPeriodEnd === true"}),": the user cancelled during their trial \u2014 the subscription ends at ",(0,i.jsx)(n.code,{children:"trialEnd"}),". Show a pending cancellation banner with a reactivate CTA."]}),"\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:'status === "active"'})," and ",(0,i.jsx)(n.code,{children:"cancelAtPeriodEnd === true"}),": the user cancelled a paid subscription. It ends at ",(0,i.jsx)(n.code,{children:"currentPeriodEnd"}),". Show a pending cancellation banner."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'if (subscription.cancelAtPeriodEnd) {\n  // Show: "Your subscription will end on [currentPeriodEnd]."\n  // Show: Reactivate button \u2192 POST /payment/reactivate-subscription\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"cancel-subscription",children:"Cancel subscription"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'POST /payment/cancel-subscription\n(no body)\n\n\u2192 { "message": "Subscription cancelled successfully" }\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Cancellation takes effect at the end of the current billing period (",(0,i.jsx)(n.code,{children:"currentPeriodEnd"}),"). The user retains access until then."]}),"\n",(0,i.jsx)(n.h3,{id:"reactivate-subscription",children:"Reactivate subscription"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'POST /payment/reactivate-subscription\n(no body)\n\n\u2192 { "message": "Subscription reactivated successfully" }\n'})}),"\n",(0,i.jsx)(n.p,{children:"Used after a subscription was cancelled or access was revoked due to payment failure."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"subscription-status-reference",children:"Subscription Status Reference"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:(0,i.jsx)(n.code,{children:"status"})}),(0,i.jsx)(n.th,{children:"Meaning"}),(0,i.jsx)(n.th,{children:"What to show"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"trialing"})}),(0,i.jsx)(n.td,{children:"Within 30-day trial"}),(0,i.jsx)(n.td,{children:"Trial banner with days remaining"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"active"})}),(0,i.jsx)(n.td,{children:"Paid and current"}),(0,i.jsx)(n.td,{children:"Normal access"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"past_due"})}),(0,i.jsx)(n.td,{children:"Payment failed, in grace period"}),(0,i.jsx)(n.td,{children:"Payment failure banner with update card CTA"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"canceled"})}),(0,i.jsx)(n.td,{children:"Subscription ended"}),(0,i.jsx)(n.td,{children:"Subscription ended screen"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"gracePeriod"})," and ",(0,i.jsx)(n.code,{children:"accessRevoked"})," fields in ",(0,i.jsx)(n.code,{children:"/payment/subscription-status"})," indicate whether the user is in a recovery window or has had access fully revoked after non-payment."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"billing-interval-ui-patterns",children:"Billing Interval UI Patterns"}),"\n",(0,i.jsx)(n.h3,{id:"plan-selector-with-interval-toggle",children:"Plan selector with interval toggle"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:'const [billingInterval, setBillingInterval] = useState<"MONTHLY" | "YEARLY">(\n  "MONTHLY"\n);\n\n// Price display helper\nfunction getPlanPrice(plan: Plan, interval: "MONTHLY" | "YEARLY") {\n  if (interval === "YEARLY") {\n    return { amount: plan.yearlyPrice, label: "/year" };\n  }\n  return { amount: plan.monthlyPrice, label: "/month" };\n}\n\n// Toggle\n<Toggle\n  options={["MONTHLY", "YEARLY"]}\n  value={billingInterval}\n  onChange={setBillingInterval}\n/>;\n\n// Pass to trial setup\nawait confirmTrial({ planType, billingInterval });\n'})}),"\n",(0,i.jsx)(n.h3,{id:"pending-yearly-switch-banner",children:"Pending yearly switch banner"}),"\n",(0,i.jsxs)(n.p,{children:["A pending yearly switch shows as ",(0,i.jsx)(n.code,{children:"cancelAtPeriodEnd: true"})," on the subscription (the monthly sub is set to cancel at period end so the yearly one can start). Distinguish it from a plain cancellation by comparing the profile's ",(0,i.jsx)(n.code,{children:"planBillingInterval"})," against the subscription's actual ",(0,i.jsx)(n.code,{children:"billingInterval"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:'const isPendingYearlySwitch =\n  subscription.cancelAtPeriodEnd &&\n  user.planBillingInterval === "YEARLY" &&\n  subscription.billingInterval === "MONTHLY";\n\n{\n  isPendingYearlySwitch && (\n    <Banner variant="info">\n      Your plan switches to yearly billing on{" "}\n      {formatDate(subscription.currentPeriodEnd)}.\n    </Banner>\n  );\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"user.planBillingInterval"})," is returned by ",(0,i.jsx)(n.code,{children:"GET /auth/profile"})," (and login/signup). ",(0,i.jsx)(n.code,{children:"subscription.billingInterval"})," comes from ",(0,i.jsx)(n.code,{children:"GET /payment/subscription-status"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"block-monthly-option-for-yearly-users",children:"Block monthly option for yearly users"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:'<BillingToggle\n  value={user.planBillingInterval}\n  onYearlyDisabledClick={() =>\n    showToast("Switch to monthly is not available on a yearly plan.")\n  }\n  yearlyDisabled={user.planBillingInterval === "YEARLY"}\n/>\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"displaying-card-brand",children:"Displaying Card Brand"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"brand"})," field returned by the API is a lowercase string from Stripe. Map it to display names:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const CARD_BRAND_LABELS: Record<string, string> = {\n  visa: "Visa",\n  mastercard: "Mastercard",\n  amex: "American Express",\n  discover: "Discover",\n  jcb: "JCB",\n  unionpay: "UnionPay",\n  diners: "Diners Club",\n  unknown: "Card",\n};\n\nfunction formatBrand(brand: string): string {\n  return CARD_BRAND_LABELS[brand.toLowerCase()] ?? brand;\n}\n\nfunction formatExpiry(month: number, year: number): string {\n  return `${String(month).padStart(2, "0")}/${String(year).slice(-2)}`;\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(n.p,{children:"All backend endpoints return standard NestJS error shapes on failure:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "statusCode": 400,\n  "message": "No default payment method found",\n  "error": "Bad Request"\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Stripe Elements errors come back on the ",(0,i.jsx)(n.code,{children:"error"})," object from ",(0,i.jsx)(n.code,{children:"confirmCardSetup"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const { error } = await stripe.confirmCardSetup(...);\nif (error) {\n  // error.message is user-safe (e.g. "Your card was declined.")\n  // error.type gives the category: "card_error" | "validation_error" | etc.\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Common Stripe error types to handle:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:(0,i.jsx)(n.code,{children:"error.type"})}),(0,i.jsx)(n.th,{children:"Cause"}),(0,i.jsx)(n.th,{children:"Suggested UX"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"card_error"})}),(0,i.jsx)(n.td,{children:"Card declined, insufficient funds, expired"}),(0,i.jsxs)(n.td,{children:["Show ",(0,i.jsx)(n.code,{children:"error.message"})," inline"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"validation_error"})}),(0,i.jsx)(n.td,{children:"Incomplete card number / CVC"}),(0,i.jsx)(n.td,{children:"Show inline, usually pre-validated by Elements"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"api_error"})}),(0,i.jsx)(n.td,{children:"Stripe-side issue"}),(0,i.jsx)(n.td,{children:'Generic "please try again" message'})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"Billing-specific error codes:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.th,{children:[(0,i.jsx)(n.code,{children:"error"})," field"]}),(0,i.jsx)(n.th,{children:"Cause"}),(0,i.jsx)(n.th,{children:"Suggested UX"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"YEARLY_DOWNGRADE_NOT_ALLOWED"})}),(0,i.jsx)(n.td,{children:"User tried to switch yearly \u2192 monthly"}),(0,i.jsx)(n.td,{children:"Hide option or show locked state"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"SWITCH_ALREADY_PENDING"})}),(0,i.jsx)(n.td,{children:"Monthly \u2192 yearly switch already scheduled"}),(0,i.jsx)(n.td,{children:"Show pending switch banner"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"reference-complete-flow-diagram",children:"Reference: Complete Flow Diagram"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'NEW USER TRIAL SETUP\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nUser selects plan + billing interval\n        \u2502\n        \u25bc\nPOST /auth/setup/trial { planType, billingInterval }\n        \u2502 returns clientSecret\n        \u25bc\nstripe.confirmCardSetup(clientSecret, { card })\n        \u2502 returns paymentMethodId\n        \u25bc\nPOST /auth/payment/attach { payment_method_id }\n        \u2502 attaches card + creates trial subscription\n        \u25bc\nShow success (trial active)\n\n\nEXISTING USER \u2014 CARD UPDATE\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nUser clicks "Change card"\n        \u2502\n        \u25bc\nPOST /payment/create-setup-intent\n        \u2502 returns clientSecret\n        \u25bc\nstripe.confirmCardSetup(clientSecret, { card })\n        \u2502 returns paymentMethodId\n        \u25bc\nPOST /payment/update-payment-method { payment_method_id }\n        \u2502 updates card + subscription default, no subscription changes\n        \u25bc\nShow updated card details\n\n\nMONTHLY \u2192 YEARLY SWITCH\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nUser selects yearly billing\n        \u2502\n        \u25bc\nPOST /plan/switch { planType, billingInterval: "YEARLY" }\n        \u2502 schedules switch at end of current monthly period\n        \u25bc\nShow pending switch banner with effective date\n        \u2502 (automatic \u2014 no frontend action needed)\n        \u25bc\nWebhook fires at period end \u2192 yearly subscription created\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"reference-component",children:"Reference Component"}),"\n",(0,i.jsx)(n.p,{children:"A working reference implementation of both flows is available at:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"docs/TrialSetup.tsx\n"})}),"\n",(0,i.jsx)(n.p,{children:"It handles loading state, error display, the plan selector, initial card collection, and the card update flow with cancel support."})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>a});var r=t(6540);const i={},s=r.createContext(i);function l(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);