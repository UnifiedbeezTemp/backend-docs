"use strict";(globalThis.webpackChunkbackend_docs=globalThis.webpackChunkbackend_docs||[]).push([[31],{4790:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"copilot/new-copilot-integration","title":"New Copilot Onboarding - Frontend Integration Guide","description":"Core Endpoints","source":"@site/docs/copilot/new-copilot-integration.md","sourceDirName":"copilot","slug":"/copilot/new-copilot-integration","permalink":"/backend-docs/docs/copilot/new-copilot-integration","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/copilot/new-copilot-integration.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Get All Channels with Access Metadata - API Documentation","permalink":"/backend-docs/docs/channels-integration/get-all-channels-with-access"},"next":{"title":"Copilot Edit Flow Documentation","permalink":"/backend-docs/docs/copilot/copilot-edit-integration"}}');var a=t(4848),i=t(8453);const o={sidebar_position:1},r="New Copilot Onboarding - Frontend Integration Guide",l={},c=[{value:"Core Endpoints",id:"core-endpoints",level:2},{value:"1. Start Conversation",id:"1-start-conversation",level:3},{value:"2. Send Message (Selection)",id:"2-send-message-selection",level:3},{value:"3. Send Message (Text Input)",id:"3-send-message-text-input",level:3},{value:"4. Send Message (Multiple Selection)",id:"4-send-message-multiple-selection",level:3},{value:"5. Send Message (Sub-Select)",id:"5-send-message-sub-select",level:3},{value:"6. Get State",id:"6-get-state",level:3},{value:"7. Upload Logo",id:"7-upload-logo",level:3},{value:"8. Delete Assistant",id:"8-delete-assistant",level:3},{value:"9. Add Assistant",id:"9-add-assistant",level:3},{value:"10. Restart Conversation",id:"10-restart-conversation",level:3},{value:"Request Validation Rules",id:"request-validation-rules",level:2},{value:"SendMessageDto Validation",id:"sendmessagedto-validation",level:3},{value:"File Upload Validation",id:"file-upload-validation",level:3},{value:"Error Responses",id:"error-responses",level:2},{value:"Validation Error",id:"validation-error",level:3},{value:"Plan Limit Error",id:"plan-limit-error",level:3},{value:"State Sync Error",id:"state-sync-error",level:3},{value:"Dynamic Substeps Requiring GET /state",id:"dynamic-substeps-requiring-get-state",level:2},{value:"Section Hierarchy &amp; Navigation",id:"section-hierarchy--navigation",level:2},{value:"Complete Flow Structure",id:"complete-flow-structure",level:3},{value:"Section Entry Points",id:"section-entry-points",level:3},{value:"Section Progression Order",id:"section-progression-order",level:3},{value:"State Transition Rules",id:"state-transition-rules",level:2},{value:"Substep Completion Flow",id:"substep-completion-flow",level:3},{value:"Section Completion Flow",id:"section-completion-flow",level:3},{value:"Dynamic Next Substep Logic",id:"dynamic-next-substep-logic",level:3},{value:"Validation Chain Architecture",id:"validation-chain-architecture",level:2},{value:"Seven-Phase Validation System",id:"seven-phase-validation-system",level:3},{value:"Validation Failure Handling",id:"validation-failure-handling",level:3},{value:"Collected Data Management",id:"collected-data-management",level:2},{value:"Core Fields Reference",id:"core-fields-reference",level:3},{value:"Field Lifecycle Patterns",id:"field-lifecycle-patterns",level:3},{value:"Data Persistence Points",id:"data-persistence-points",level:3},{value:"Dynamic Option Hydration",id:"dynamic-option-hydration",level:2},{value:"Runtime Option Generation",id:"runtime-option-generation",level:3},{value:"Hydration Timing",id:"hydration-timing",level:3},{value:"Special Flow Patterns",id:"special-flow-patterns",level:2},{value:"Business Search Flow",id:"business-search-flow",level:3},{value:"Team Size Validation Flow",id:"team-size-validation-flow",level:3},{value:"Channel Configuration Flow",id:"channel-configuration-flow",level:3},{value:"AI Assistant Assignment Flow",id:"ai-assistant-assignment-flow",level:3},{value:"Automation Selection Flow",id:"automation-selection-flow",level:3},{value:"State Synchronization Patterns",id:"state-synchronization-patterns",level:2},{value:"When Frontend Should Call GET /state",id:"when-frontend-should-call-get-state",level:3},{value:"Optimistic Updates Pattern",id:"optimistic-updates-pattern",level:3},{value:"State Reconciliation on Errors",id:"state-reconciliation-on-errors",level:3},{value:"Completion &amp; Terminal States",id:"completion--terminal-states",level:2},{value:"Conversation Completion Detection",id:"conversation-completion-detection",level:3},{value:"Section Completion Detection",id:"section-completion-detection",level:3},{value:"Substep Skip vs Complete",id:"substep-skip-vs-complete",level:3},{value:"Edge Cases Matrix",id:"edge-cases-matrix",level:2},{value:"Comprehensive Edge Case Reference",id:"comprehensive-edge-case-reference",level:3},{value:"Code Examples &amp; Integration Snippets",id:"code-examples--integration-snippets",level:2},{value:"Example 1: Complete Message Send Flow",id:"example-1-complete-message-send-flow",level:3},{value:"Example 2: Dynamic Option Hydration",id:"example-2-dynamic-option-hydration",level:3},{value:"Example 3: Edit Flow with Context Awareness",id:"example-3-edit-flow-with-context-awareness",level:3},{value:"Example 4: File Upload with Validation",id:"example-4-file-upload-with-validation",level:3},{value:"Example 5: Assistant Add/Delete with Optimistic UI",id:"example-5-assistant-adddelete-with-optimistic-ui",level:3},{value:"Example 6: State Persistence &amp; Recovery",id:"example-6-state-persistence--recovery",level:3},{value:"Troubleshooting Guide",id:"troubleshooting-guide",level:2},{value:"Common Issues &amp; Solutions",id:"common-issues--solutions",level:3},{value:"Testing Scenarios",id:"testing-scenarios",level:2},{value:"Unit Test Cases",id:"unit-test-cases",level:3},{value:"Integration Test Scenarios",id:"integration-test-scenarios",level:3},{value:"Complete Documentation Summary",id:"complete-documentation-summary",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"new-copilot-onboarding---frontend-integration-guide",children:"New Copilot Onboarding - Frontend Integration Guide"})}),"\n",(0,a.jsx)(n.h1,{id:"section-a-normal-flow-api-reference",children:"Section A: Normal Flow API Reference"}),"\n",(0,a.jsx)(n.h2,{id:"core-endpoints",children:"Core Endpoints"}),"\n",(0,a.jsx)(n.h3,{id:"1-start-conversation",children:"1. Start Conversation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'POST /copilot/start\n\nRequest: None (authenticated via session)\n\nResponse: CopilotResponseDto\n{\n  currentSubstep: {\n    id: "planConfirmation"\n    name: "planConfirmation"\n    parentStepId: "businessIdentity"\n    canEdit: false\n    isComplete: false\n    type: "choice"\n    formField: ""\n    botMessage: [\n      {\n        message: "Hi {firstName}, I\'m Beezaro\\n\\nPlease confirm...",\n        type: "text",\n        component: null\n      },\n      {\n        message: null,\n        type: "component",\n        component: "planSummary"\n      }\n    ]\n    options: [\n      {\n        label: "Yes, Proceed with my current plan",\n        value: true,\n        type: "radio",\n        nextSubstepId: "businessIndustry"\n      },\n      {\n        label: "No, Change plan",\n        value: false,\n        type: "radio",\n        nextSubstepId: "changePlan"\n      }\n    ]\n    optionsListClasses: "grid grid-cols-1 max-w-[28.7rem]..."\n    showNextStepButton: false\n  }\n  uiDirectives: {\n    components: [\n      { name: "planSummary", metadata: {} }\n    ]\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"2-send-message-selection",children:"2. Send Message (Selection)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'POST /copilot/message\n\nRequest: SendMessageDto\n{\n  inputType: "selection",\n  content: "Yes, Proceed with my current plan", // Display text\n  metadata: {\n    substepId: "planConfirmation",  // REQUIRED - must match current substep\n    selectedOption: true             // Actual value from option.value\n  }\n}\n\nResponse: CopilotResponseDto\n{\n  currentSubstep: {\n    id: "businessIndustry",\n    type: "choice",\n    botMessage: [...],\n    options: [\n      {\n        emoji: "\ud83d\udecd\ufe0f",\n        label: "E-commerce / Retail",\n        value: "ECOMMERCE_RETAIL",\n        type: "radio",\n        nextSubstepId: "businessName"\n      },\n      // ... more industries\n      {\n        label: "Category not listed here",\n        value: "none",\n        type: "radio",\n        nextSubstepId: "categoryNotListed",\n        isCustom: true\n      }\n    ]\n  },\n  lastUserMessage: {\n    messageType: "USER_SELECTION",\n    content: "Yes, Proceed with my current plan",\n    metadata: { substepId: "planConfirmation", ... },\n    createdAt: "2024-01-15T10:30:00Z"\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"3-send-message-text-input",children:"3. Send Message (Text Input)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'POST /copilot/message\n\nRequest: SendMessageDto\n{\n  inputType: "text",\n  content: "Acme Electronics",\n  metadata: {\n    substepId: "businessName"\n  }\n}\n\nResponse: CopilotResponseDto\n{\n  currentSubstep: {\n    id: "selectBusinessNameMatch",\n    botMessage: [\n      {\n        message: "Here are a few businesses I found...",\n        type: "text"\n      }\n    ],\n    options: [\n      {\n        label: "Acme Electronics Inc.",\n        value: {\n          name: "Acme Electronics Inc.",\n          address: "123 Main St",\n          phone: "+1234567890",\n          website: "https://acme.com",\n          logo_url: "https://...",\n          source: "google_places",\n          confidence: 0.95\n        },\n        type: "radio",\n        nextSubstepId: "confirmBusinessData"\n      },\n      // ... more matches\n      {\n        label: "My business isn\'t listed",\n        value: "",\n        type: "radio",\n        nextSubstepId: "businessNotListed",\n        isCustom: true\n      }\n    ]\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"4-send-message-multiple-selection",children:"4. Send Message (Multiple Selection)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'POST /copilot/message\n\nRequest: SendMessageDto\n{\n  inputType: "selection",\n  content: "WhatsApp, Gmail",\n  metadata: {\n    substepId: "channels",\n    selectedOptions: ["whatsapp", "gmail"]  // Array for multiple\n  }\n}\n\nResponse: CopilotResponseDto\n{\n  currentSubstep: {\n    id: "confirmChannelsConfiguration",\n    botMessage: [\n      {\n        message: "Great! I\'ve noted these channels: WhatsApp, Gmail.",\n        type: "text"\n      }\n    ],\n    options: [\n      {\n        label: "Configure now (Manual Setup)",\n        value: false,\n        type: "button",\n        isExitOption: true\n      },\n      {\n        label: "Use recommended settings",\n        value: true,\n        type: "button"\n      }\n    ]\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"5-send-message-sub-select",children:"5. Send Message (Sub-Select)"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'POST /copilot/message\n\nRequest: SendMessageDto\n{\n  inputType: "selection",\n  content: "Yes, add automation",\n  metadata: {\n    substepId: "addAutomations",\n    selectedOption: "yes",\n    subSelectValues: [          // Required when option has hasSubselect\n      "Tag new leads",\n      "Follow-up after 24h"\n    ]\n  }\n}\n\nResponse: CopilotResponseDto\n{\n  currentSubstep: {\n    id: "confirmAIAutomations",\n    botMessage: [\n      {\n        message: "Great, I\'ll add these automations:\\nTag new leads, Follow-up after 24h",\n        type: "text"\n      }\n    ]\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"6-get-state",children:"6. Get State"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'GET /copilot/state\n\nResponse: CopilotStateResponseDto\n{\n  conversationId: 123,\n  currentSection: "businessIdentity",\n  currentSubstep: "confirmBusinessData",\n  sessionState: {\n    current_section: "businessIdentity",\n    current_substep: "confirmBusinessData",\n    last_interaction: "2024-01-15T10:45:00Z",\n    collected_data: {\n      firstName: "John",\n      selected_plan: "BUSINESS",\n      industry: "ECOMMERCE_RETAIL",\n      business_name: "Acme Electronics",\n      selected_business: {\n        name: "Acme Electronics Inc.",\n        logo_url: "https://...",\n        // ... full business object\n      },\n      suggested_goals: [\n        { title: "Increase sales", description: "..." }\n      ],\n      // ... all accumulated data\n    },\n    completed_sections: [],\n    completed_substeps: [\n      "planConfirmation",\n      "businessIndustry",\n      "businessName",\n      "selectBusinessNameMatch"\n    ],\n    skipped_substeps: [],\n    edit_history: [],\n    is_in_edit_flow: false\n  },\n  isActive: true,\n  isCompleted: false,\n  recentMessages: [\n    {\n      messageType: "BOT_MESSAGE",\n      content: "Perfect! I\'ll set you up as...",\n      metadata: { section: "businessIdentity", ... },\n      createdAt: "2024-01-15T10:40:00Z"\n    },\n    // ... last 20 messages\n  ],\n  currentSubstepDetails: {\n    currentSubstep: {\n      id: "confirmBusinessData",\n      botMessage: [\n        {\n          message: "**Acme Electronics Inc.**\\n\ud83c\udf10 https://acme.com...",\n          type: "text"\n        }\n      ],\n      options: [...]\n    },\n    uiDirectives: {\n      components: [\n        {\n          name: "businessLogo",\n          metadata: {\n            logoUrl: "https://...",\n            businessName: "Acme Electronics Inc.",\n            website: "https://acme.com"\n          }\n        }\n      ]\n    }\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"7-upload-logo",children:"7. Upload Logo"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'POST /copilot/upload-logo\nContent-Type: multipart/form-data\n\nRequest:\n{\n  logo: File,                    // Max 5MB, PNG/JPG/WEBP only\n  substepId: "businessNotListed" // Always this value\n}\n\nResponse: CopilotResponseDto\n{\n  currentSubstep: {\n    id: "confirmBusinessData",\n    botMessage: [\n      {\n        message: "Perfect! Here\'s your business setup:",\n        type: "text"\n      }\n    ]\n  },\n  uiDirectives: {\n    components: [\n      {\n        name: "businessLogo",\n        metadata: {\n          logoUrl: "https://s3.../business-logos/123/uuid.png",\n          businessName: "Acme Electronics",\n          website: null\n        }\n      }\n    ]\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"8-delete-assistant",children:"8. Delete Assistant"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'DELETE /copilot/assistants/:assistantId\n\nResponse: CopilotResponseDto\n{\n  currentSubstep: {\n    id: "beezaroAssistants",\n    botMessage: [\n      {\n        type: "component",\n        component: "CopilotContext",\n        metadata: {\n          event: "assistant_deleted",\n          previousPosition: { section: "channels", substep: "channels" },\n          nextPosition: { section: "aiAssistant", substep: "beezaroAssistants" }\n        }\n      },\n      {\n        type: "text",\n        message: "Assistant removed. Channels were reassigned automatically."\n      },\n      {\n        type: "component",\n        component: "AssistantCard",\n        metadata: { id: 456, name: "Beezaro Swift", onboardingDraft: true }\n      },\n      // ... remaining assistants\n    ]\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"9-add-assistant",children:"9. Add Assistant"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'POST /copilot/assistants\n\nResponse: CopilotResponseDto\n{\n  currentSubstep: {\n    id: "beezaroAssistants",\n    botMessage: [\n      {\n        type: "component",\n        component: "CopilotContext",\n        metadata: { event: "assistant_added" }\n      },\n      {\n        type: "text",\n        message: "New assistant added. Channel assignments were rebalanced automatically."\n      },\n      // ... all assistants including new one\n    ]\n  }\n}\n\n// OR (if called outside conversation flow):\nResponse: CopilotResponseDto\n{\n  currentSubstep: null,\n  uiDirectives: {\n    refreshAssistants: true,\n    assistantMutation: {\n      createdAssistant: {\n        id: 789,\n        name: "Beezaro Zen",\n        onboardingDraft: true\n      },\n      createdAssistants: [\n        { id: 456, name: "Beezaro Swift" },\n        { id: 789, name: "Beezaro Zen" }\n      ],\n      draftChannelConfigs: [\n        {\n          channelAiConfigId: 1,\n          connectedChannelId: 10,\n          aiAssistantId: 456,\n          // ... config details\n        },\n        // ... updated configs\n      ]\n    }\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"10-restart-conversation",children:"10. Restart Conversation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'POST /copilot/restart\n{\n  sectionId?: "channels",     // Optional: jump to specific section\n  substepId?: "channels"      // Optional: jump to specific substep\n}\n\nResponse: CopilotResponseDto\n{\n  currentSubstep: {\n    id: "planConfirmation",  // Or specified substep\n    // ... fresh substep data\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"request-validation-rules",children:"Request Validation Rules"}),"\n",(0,a.jsx)(n.h3,{id:"sendmessagedto-validation",children:"SendMessageDto Validation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// CRITICAL: substepId must match current position\nmetadata.substepId === currentState.current_substep  // Must be true\n\n// Input type must match substep type\nsubstep.type === "choice" \u2192 inputType: "selection"\nsubstep.type === "input"  \u2192 inputType: "text"\nsubstep.type === "button" \u2192 inputType: "selection"\nsubstep.type === "custom" \u2192 inputType: "custom"\n\n// Selection format validation\nsubstep.multiple === true  \u2192 metadata.selectedOptions: string[]\nsubstep.multiple === false \u2192 metadata.selectedOption: any\n\n// Sub-select validation\noption.hasSubselect === true \u2192 metadata.subSelectValues: string[] (required)\n'})}),"\n",(0,a.jsx)(n.h3,{id:"file-upload-validation",children:"File Upload Validation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Logo upload constraints\nmimeType: ["image/png", "image/jpeg", "image/jpg", "image/webp"];\nmaxSize: 5 * 1024 * 1024; // 5MB\nsubstepId: "businessNotListed"; // Only valid value\n'})}),"\n",(0,a.jsx)(n.h2,{id:"error-responses",children:"Error Responses"}),"\n",(0,a.jsx)(n.h3,{id:"validation-error",children:"Validation Error"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'Status: 400 Bad Request\n{\n  message: "Validation failed",\n  errors: [\n    "Invalid option \\"xyz\\". Available options: option1, option2"\n  ],\n  substepId: "channels",\n  section: "channels",\n  hint: "Please call GET /copilot/state to sync your current position"\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"plan-limit-error",children:"Plan Limit Error"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'Status: 400 Bad Request\n{\n  message: "Team size \\"21 or more\\" requires the ORGANISATION plan",\n  substepId: "teamSize",\n  requiresUpgrade: true,\n  currentPlan: "BUSINESS",\n  limit: 10,\n  hint: "Please upgrade your plan or select fewer/different channels"\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"state-sync-error",children:"State Sync Error"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'Status: 400 Bad Request\n{\n  message: "Invalid substep context - expected confirmBusinessData, received businessName",\n  substepId: "businessName",\n  currentState: {\n    section: "businessIdentity",\n    substep: "confirmBusinessData"\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"dynamic-substeps-requiring-get-state",children:"Dynamic Substeps Requiring GET /state"}),"\n",(0,a.jsx)(n.p,{children:"These substeps have runtime-generated options:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Always call GET /state before rendering:\n"businessIndustry"; // Options from IndustryType enum\n"selectBusinessNameMatch"; // Options from business search results\n"channels"; // Options from user\'s available channels\n"adjustGoalsObjectives"; // Options from active goals/objectives DB\n\n// State contains the data in:\nstate.sessionState.collected_data.business_search_results; // For selectBusinessNameMatch\nstate.currentSubstepDetails.currentSubstep.options; // For all others\n'})}),"\n",(0,a.jsx)(n.h1,{id:"section-b-flow-logic--state-management",children:"Section B: Flow Logic & State Management"}),"\n",(0,a.jsx)(n.h2,{id:"section-hierarchy--navigation",children:"Section Hierarchy & Navigation"}),"\n",(0,a.jsx)(n.h3,{id:"complete-flow-structure",children:"Complete Flow Structure"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"Flow Hierarchy:\n\u251c\u2500\u2500 businessIdentity (Section)\n\u2502   \u251c\u2500\u2500 planConfirmation (entry point)\n\u2502   \u251c\u2500\u2500 businessIndustry\n\u2502   \u251c\u2500\u2500 categoryNotListed (conditional)\n\u2502   \u251c\u2500\u2500 businessName\n\u2502   \u251c\u2500\u2500 selectBusinessNameMatch\n\u2502   \u251c\u2500\u2500 businessNotListed (conditional)\n\u2502   \u251c\u2500\u2500 confirmBusinessData\n\u2502   \u251c\u2500\u2500 adjustGoalsObjectives (conditional)\n\u2502   \u2514\u2500\u2500 adjustGoalsConfirm (conditional)\n\u2502\n\u251c\u2500\u2500 teamMembers (Section)\n\u2502   \u251c\u2500\u2500 teamSize (entry point)\n\u2502   \u251c\u2500\u2500 teamSizeOverLimit (conditional - plan validation failed)\n\u2502   \u251c\u2500\u2500 teamPlanDetails (conditional)\n\u2502   \u251c\u2500\u2500 teamUpgradeOptions (conditional)\n\u2502   \u2514\u2500\u2500 teamUpgradeConfirm (conditional)\n\u2502\n\u251c\u2500\u2500 channels (Section)\n\u2502   \u251c\u2500\u2500 channels (entry point)\n\u2502   \u2514\u2500\u2500 confirmChannelsConfiguration\n\u2502\n\u251c\u2500\u2500 fallbackLogic (Section)\n\u2502   \u251c\u2500\u2500 noReplyConfiguration (entry point)\n\u2502   \u2514\u2500\u2500 confirmNoReplyConfiguration\n\u2502\n\u251c\u2500\u2500 aiAssistant (Section)\n\u2502   \u251c\u2500\u2500 aiAssistantsForChannels (entry point)\n\u2502   \u2514\u2500\u2500 beezaroAssistants\n\u2502\n\u2514\u2500\u2500 automation (Section)\n    \u251c\u2500\u2500 addAutomations (entry point)\n    \u251c\u2500\u2500 confirmAIAutomations (conditional)\n    \u2514\u2500\u2500 finalizeSetup (conditional)\n"})}),"\n",(0,a.jsx)(n.h3,{id:"section-entry-points",children:"Section Entry Points"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Every section has a defined entry substep:\n{\n  businessIdentity: "planConfirmation",\n  teamMembers: "teamSize",\n  channels: "channels",\n  fallbackLogic: "noReplyConfiguration",\n  aiAssistant: "aiAssistantsForChannels",\n  automation: "addAutomations"\n}\n\n// Backend enforces: When entering a new section, always start at entry substep\n// Retrieved via: section.entry || Object.keys(section.subSteps)[0]\n'})}),"\n",(0,a.jsx)(n.h3,{id:"section-progression-order",children:"Section Progression Order"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// Linear section flow (no branching at section level):\nbusinessIdentity \u2192 teamMembers \u2192 channels \u2192 fallbackLogic \u2192 aiAssistant \u2192 automation\n\n// Determined by: flowService.getNextSection(currentSection)\n// Terminal condition: getNextSection() returns null after automation\n"})}),"\n",(0,a.jsx)(n.h2,{id:"state-transition-rules",children:"State Transition Rules"}),"\n",(0,a.jsx)(n.h3,{id:"substep-completion-flow",children:"Substep Completion Flow"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Standard progression (happy path):\n1. User submits valid input via POST /copilot/message\n2. Backend validates:\n   - Phase 7: Comprehensive message validation (format, context, options)\n   - Phase 2: Choice validation (if substep.type === "choice")\n   - Phase 4: Text input validation (if substep.type === "input")\n3. Backend records user message\n4. Backend updates collected_data[substep.formField] = value\n5. Backend marks substep complete: completed_substeps.push(substep.id)\n6. Backend determines next substep:\n   - Check substep.isEndOfStep === true \u2192 trigger section completion\n   - Call getNextSubstep(currentSubstep, userValue) \u2192 get dynamic next\n   - Validate next substep prerequisites\n7. Backend updates position: { current_section, current_substep }\n8. Backend records bot message for new substep\n9. Response includes new currentSubstep + lastUserMessage\n\n// Terminal conditions:\n- isEndOfStep === true \u2192 handleSectionComplete()\n- getNextSubstep() returns null \u2192 handleSectionComplete()\n- getNextSection() returns null \u2192 conversation complete\n'})}),"\n",(0,a.jsx)(n.h3,{id:"section-completion-flow",children:"Section Completion Flow"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// Triggered when substep.isEndOfStep === true OR no next substep exists:\n\n1. Backend validates section completion:\n   - Phase 6: validateSectionCompletion()\n   - Checks all required substeps completed\n   - Validates no missing prerequisites\n\n2. Backend marks section complete:\n   - completed_sections.push(section.id)\n   - Records SECTION_COMPLETE system event\n\n3. Backend clears transient data (e.g., business_search_results)\n\n4. Backend checks edit context:\n   IF (state.is_in_edit_flow && state.edit_return_position):\n     - Clear edit context\n     - Navigate to edit_return_position\n     - Return with uiDirectives.editComplete = true\n   ELSE:\n     - Get next section via getNextSection()\n     - Navigate to next section's entry substep\n     - Return with sectionComplete = true\n\n5. Response patterns:\n   {\n     currentSubstep: { ... },      // Next section's entry substep\n     sectionComplete: true,\n     uiDirectives: { components: [...] }\n   }\n\n   OR (if conversation complete):\n   {\n     currentSubstep: null,\n     conversationComplete: true,\n     uiDirectives: {}\n   }\n"})}),"\n",(0,a.jsx)(n.h3,{id:"dynamic-next-substep-logic",children:"Dynamic Next Substep Logic"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Option-based navigation (most common):\noption.nextSubstepId determines next step\n\nExample:\n{\n  label: "Yes, Proceed with my current plan",\n  value: true,\n  nextSubstepId: "businessIndustry"  // Explicit navigation\n}\n\n// Value-based branching:\nif (value === "none") {\n  nextSubstepId = "categoryNotListed"\n} else {\n  nextSubstepId = "businessName"\n}\n\n// Conditional substeps (only visited if condition met):\n- businessNotListed: only if user selects "My business isn\'t listed"\n- categoryNotListed: only if industry === "none"\n- teamSizeOverLimit: only if team size > plan limit\n- adjustGoalsObjectives: only if user selects "I want to adjust that"\n'})}),"\n",(0,a.jsx)(n.h2,{id:"validation-chain-architecture",children:"Validation Chain Architecture"}),"\n",(0,a.jsx)(n.h3,{id:"seven-phase-validation-system",children:"Seven-Phase Validation System"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Phase 1: Entry Validation (before any processing)\nLocation: Start of handleMessage()\nChecks:\n- Active conversation exists\n- Current position retrievable\n\n// Phase 2: Choice Validation (for type: "choice" substeps)\nLocation: handleContextualInput() \u2192 validateChoice()\nChecks:\n- selectedOption exists in substep.options\n- selectedOption value matches option.value exactly\n- If option has subselect: subSelectValues provided and valid\nExample error:\n{\n  message: "Invalid selection. Available options: confirm, adjustGoals",\n  substepId: "confirmBusinessData",\n  availableOptions: [...]\n}\n\n// Phase 3: Plan Validation (for plan-restricted features)\nLocation: Multiple handlers (team size, channels, assistants)\nChecks:\n- Team size within plan.maxSeats limit\n- Channel count within plan limits (WhatsApp, CRM, etc.)\n- AI assistant count within plan.maxAiAssistants\nExample error:\n{\n  message: "Team size \\"21 or more\\" requires the ORGANISATION plan",\n  requiresUpgrade: true,\n  currentPlan: "BUSINESS",\n  limit: 10\n}\n\n// Phase 4: Text Input Validation (for type: "input" substeps)\nLocation: validateTextInput()\nChecks:\n- Non-empty string\n- Length limits (1-500 chars typically)\n- Sanitization (trim, remove dangerous chars)\n- Field-specific rules (e.g., business name format)\nExample error:\n{\n  message: "Business name must be between 1 and 200 characters",\n  substepId: "businessName",\n  field: "businessName",\n  providedValue: ""\n}\n\n// Phase 5: Prerequisites & Flow Validation\nLocation: processSubstepCompletion() \u2192 validateNextSubstep()\nChecks:\n- Next substep exists in flow config\n- Next substep belongs to current section\n- All prerequisite substeps completed\n- No circular dependencies\nExample error:\n{\n  message: "Cannot advance to confirmBusinessData - missing prerequisites",\n  currentSubstep: "businessName",\n  attemptedNext: "confirmBusinessData",\n  missingSteps: ["selectBusinessNameMatch"]\n}\n\n// Phase 6: Section Completion Validation\nLocation: handleSectionComplete() \u2192 validateSectionCompletion()\nChecks:\n- All required (non-skippable) substeps completed\n- No orphaned state (e.g., selected channels but no config)\nExample error:\n{\n  message: "Section cannot be completed - missing required steps",\n  section: "businessIdentity",\n  missingSteps: ["confirmBusinessData"]\n}\n\n// Phase 7: Comprehensive Message Validation (entry gate)\nLocation: handleMessage() \u2192 validateMessage()\nChecks:\n- inputType matches substep.type\n- metadata.substepId matches current_substep\n- For selections: option exists and is valid\n- For text: meets field requirements\n- State prerequisites satisfied\nExample error:\n{\n  message: "Validation failed",\n  errors: ["substepId mismatch: expected confirmBusinessData, received businessName"],\n  substepId: "businessName",\n  section: "businessIdentity",\n  hint: "Please call GET /copilot/state to sync your current position"\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"validation-failure-handling",children:"Validation Failure Handling"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// All validation failures throw BadRequestException:\nthrow new BadRequestException({\n  message: "Primary error message",\n  errors?: string[],           // Array of specific validation failures\n  substepId: string,           // Current or target substep\n  section?: string,            // Current section\n  hint?: string,               // Developer guidance\n  availableOptions?: any[],    // For choice validation errors\n  currentState?: object        // For sync errors\n})\n\n// Frontend should:\n1. Display message to user\n2. If hint present: log for debugging\n3. If availableOptions present: show valid choices\n4. If currentState mismatch: call GET /state to resync\n5. Never retry without user action\n'})}),"\n",(0,a.jsx)(n.h2,{id:"collected-data-management",children:"Collected Data Management"}),"\n",(0,a.jsx)(n.h3,{id:"core-fields-reference",children:"Core Fields Reference"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'interface CollectedData {\n  // Identity section\n  firstName: string; // From user.fullName.split(" ")[0]\n  selected_plan: PlanType; // From planConfirmation\n  industry: IndustryType; // From businessIndustry\n  businessCategory: string; // Display name of industry\n  additionalCategoryMessage: string; // "your industry" or custom\n  business_name: string; // From businessName input\n  business_search_results: BusinessMatch[]; // Temporary - cleared after section\n  selected_business: BusinessMatch; // From selectBusinessNameMatch\n  business_logo: string; // S3 URL from upload\n  suggested_goals: Goal[]; // LLM-generated\n  suggested_objectives: Objective[]; // LLM-generated\n  ai_summary: string; // LLM explanation of goals\n  adjustedGoalsSummary?: string; // If user adjusted goals\n  goalsAdjustmentMode?: "kept" | "adjusted";\n\n  // Team section\n  team_size: string; // "1" | "2-5" | "6-20" | "21"\n  team_size_attempt: string; // Attempted size (may exceed limit)\n  team_size_attempt_label: string; // Display label for attempt\n\n  // Channels section\n  channels: string[]; // Display names\n  selected_channel_values: string[]; // Internal values (e.g., "whatsapp")\n  useRecommendedSettings: boolean; // From confirmChannelsConfiguration\n\n  // Fallback section\n  noReplyConfiguration: string; // "escalate" | "followUp" | "none"\n\n  // AI Assistant section\n  aiAssistantsForChannels: string; // "single" | "multiple"\n  created_assistants: Array<{\n    // Draft assistants created\n    id: number;\n    name: string;\n  }>;\n  draft_channel_configs: ChannelConfig[]; // Temporary configs (onboardingDraft: true)\n\n  // Automation section\n  selected_automations: string[]; // Preset keys\n  addAutomations: boolean; // Whether user opted in\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"field-lifecycle-patterns",children:"Field Lifecycle Patterns"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// Transient fields (cleared after use):\nbusiness_search_results  // Cleared at end of businessIdentity section\ndraft_channel_configs    // Finalized at beezaroAssistants completion\ncreated_assistants       // Finalized at beezaroAssistants completion\n\n// Persistent fields (kept throughout):\nfirstName, selected_plan, industry, business_name, selected_business\nteam_size, channels, selected_channel_values\naiAssistantsForChannels, noReplyConfiguration\n\n// Updated fields (overwritten during edits):\nAny field can be updated via:\n- Normal flow: stateService.updateCollectedData()\n- Edit flow: editSubstep() \u2192 updateCollectedData()\n\n// Cleared fields (on edit impact):\nWhen edit affects dependent substeps, related fields cleared:\nExample: Edit industry \u2192 clears suggested_goals, suggested_objectives\n"})}),"\n",(0,a.jsx)(n.h3,{id:"data-persistence-points",children:"Data Persistence Points"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// collected_data is stored in:\nconversation.sessionState (JSON column in DB)\n\n// Updated after every:\n1. Substep completion: formField value stored\n2. Special handlers: multiple fields at once\n3. Edit operations: target field + clear affected fields\n4. Section completion: cleanup of transient data\n\n// Accessed via:\nstate = parseSessionState(conversation.sessionState)\nvalue = state.collected_data[fieldName]\n\n// Never accessed directly - always through state service\n"})}),"\n",(0,a.jsx)(n.h2,{id:"dynamic-option-hydration",children:"Dynamic Option Hydration"}),"\n",(0,a.jsx)(n.h3,{id:"runtime-option-generation",children:"Runtime Option Generation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// These substeps MUST fetch options at runtime (cannot cache):\n\n1. businessIndustry\n   Source: IndustryType enum + formatting\n   Pattern:\n   const industries = Object.values(IndustryType)\n   options = industries.map(industry => ({\n     emoji: getIndustryEmoji(industry),\n     label: getIndustryLabel(industry),\n     value: industry,\n     type: "radio",\n     nextSubstepId: "businessName"\n   }))\n\n   Trigger: withBusinessIndustryOptions(substep)\n   When: handleMessage(), getState(), restartConversation()\n\n2. selectBusinessNameMatch\n   Source: state.collected_data.business_search_results\n   Pattern:\n   options = [\n     ...searchResults.map(match => ({\n       label: match.name,\n       value: match,  // FULL OBJECT\n       type: "radio",\n       nextSubstepId: "confirmBusinessData"\n     })),\n     {\n       label: "My business isn\'t listed",\n       value: "",\n       isCustom: true,\n       type: "radio",\n       nextSubstepId: "businessNotListed"\n     }\n   ]\n\n   Trigger: Check state.collected_data.business_search_results exists\n   When: After businessName input processed\n\n3. channels\n   Source: channelService.getAvailableChannels(userId)\n   Pattern:\n   const availableChannels = await channelService.getAvailableChannels(userId)\n   const allChannels = [\n     ...availableChannels.categories.communication.available,\n     ...availableChannels.categories.crmCalendar.available,\n     ...availableChannels.categories.ecommerce.available\n   ]\n   options = allChannels.map(channel => ({\n     label: channel.displayName,\n     value: channel.name,\n     type: "select",\n     icon: getChannelIcon(channel.name)\n   }))\n\n   Trigger: substep.id === "channels"\n   When: handleMessage(), getState()\n\n4. adjustGoalsObjectives\n   Source: Database query for active goals/objectives\n   Pattern:\n   const { goals, objectives } = await getActiveGoalsAndObjectives()\n   options = [\n     ...goals.map(g => ({\n       label: g.title,\n       description: g.description,\n       value: `goal:${g.id}`,\n       type: "checkbox"\n     })),\n     ...objectives.map(o => ({\n       label: o.title,\n       description: o.description,\n       value: `objective:${o.id}`,\n       type: "checkbox"\n     })),\n     {\n       label: "Keep current goals and objectives",\n       value: "keepCurrent",\n       type: "button",\n       nextSubstepId: "confirmBusinessData"\n     }\n   ]\n\n   Trigger: substep.id === "adjustGoalsObjectives"\n   When: User selects "I want to adjust that" from confirmBusinessData\n'})}),"\n",(0,a.jsx)(n.h3,{id:"hydration-timing",children:"Hydration Timing"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Frontend MUST call GET /state before rendering these substeps:\n- businessIndustry (always hydrated, but verify options present)\n- selectBusinessNameMatch (only if business_search_results exists in state)\n- channels (always requires fresh fetch per plan/connections)\n- adjustGoalsObjectives (always requires DB fetch)\n\n// Backend automatically hydrates during:\nhandleMessage() {\n  if (currentSubstep.id === "businessIndustry") {\n    currentSubstep = withBusinessIndustryOptions(currentSubstep)\n  }\n  // ... other hydrations\n}\n\ngetState() {\n  let substep = await getSubstep(section, substepId)\n  if (substepId === "channels") {\n    substep = { ...substep, options: [...dynamicChannels] }\n  }\n  // ... other hydrations\n  return substep\n}\n\n// Frontend rendering logic:\nif (["businessIndustry", "channels", "adjustGoalsObjectives"].includes(substep.id)) {\n  // Options already hydrated in response - render directly\n}\n\nif (substep.id === "selectBusinessNameMatch") {\n  // Check if options array is populated\n  if (!substep.options?.length) {\n    // Call GET /state to trigger hydration\n    const state = await GET /copilot/state\n    substep = state.currentSubstepDetails.currentSubstep\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"special-flow-patterns",children:"Special Flow Patterns"}),"\n",(0,a.jsx)(n.h3,{id:"business-search-flow",children:"Business Search Flow"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Pattern: Search \u2192 Match \u2192 Confirm OR Manual Entry\n\nFlow:\n1. businessName (input)\n   \u2193\n2. Backend searches via businessLookupService.searchBusiness(name)\n   \u2193\n3. Stores results in state.collected_data.business_search_results\n   \u2193\n4. Advances to selectBusinessNameMatch\n   \u2193\n5a. User selects match \u2192 confirmBusinessData\n    - Stores full business object in selected_business\n    - LLM generates goals based on business + industry\n\n5b. User selects "not listed" \u2192 businessNotListed\n    - Clears selected_business\n    - Requires logo upload\n    - Uses business_name for confirmBusinessData\n\n// Key implementation details:\n- business_search_results populated at businessName completion\n- businessNotListed bypasses search results, uses manual data\n- confirmBusinessData works with EITHER selected_business OR manual entry\n- business_search_results cleared at end of businessIdentity section\n'})}),"\n",(0,a.jsx)(n.h3,{id:"team-size-validation-flow",children:"Team Size Validation Flow"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Pattern: Size Selection \u2192 Plan Validation \u2192 Upgrade Flow OR Continue\n\nFlow:\n1. teamSize (choice)\n   User selects: "1" | "2-5" | "6-20" | "21"\n   \u2193\n2. Backend validates against plan.maxSeats\n   const validation = await validateTeamSizeAgainstPlan(size, userId)\n   \u2193\n3a. VALID \u2192 Store team_size, advance to next section\n\n3b. INVALID \u2192 Navigate to teamSizeOverLimit\n    - Store team_size_attempt + team_size_attempt_label\n    - Present upgrade options\n    \u2193\n4. teamSizeOverLimit (choice)\n   Options: "upgrade" | "planDetails" | default (smaller size)\n   \u2193\n5a. "upgrade" \u2192 teamUpgradeOptions\n    - Show plan comparison\n    - User selects new plan\n    - On confirm \u2192 teamUpgradeConfirm\n\n5b. "planDetails" \u2192 teamPlanDetails\n    - Show current plan details\n    - Options: "upgrade" | "stay" | "smaller"\n\n5c. default \u2192 Back to teamSize with limit reminder\n\n6. teamUpgradeConfirm\n   - Finalizes plan upgrade\n   - Stores team_size from team_size_attempt\n   - Advances to next section\n\n// Critical: team_size only stored if validation passes\n// team_size_attempt tracks what user wants (may exceed limit)\n'})}),"\n",(0,a.jsx)(n.h3,{id:"channel-configuration-flow",children:"Channel Configuration Flow"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Pattern: Select Channels \u2192 Config Strategy \u2192 Setup OR Manual\n\nFlow:\n1. channels (multiple selection)\n   User selects: ["whatsapp", "gmail", ...]\n   \u2193\n2. Backend validates against plan limits\n   - Max WhatsApp channels\n   - CRM/Calendar addon access\n   - Ecommerce pack access\n   \u2193\n3. Backend creates ConnectedChannel records\n   await channelService.selectChannel(userId, { availableChannelId, customName })\n   \u2193\n4. Stores in collected_data:\n   - channels: ["WhatsApp", "Gmail"] (display names)\n   - selected_channel_values: ["whatsapp", "gmail"] (internal values)\n   \u2193\n5. confirmChannelsConfiguration (choice)\n   Options: "Use recommended settings" (true) | "Configure now (Manual)" (false)\n   \u2193\n6a. useRecommendedSettings === true\n    \u2192 noReplyConfiguration (fallbackLogic section)\n    \u2192 Creates draft configs with industry-based recommendations\n\n6b. useRecommendedSettings === false\n    \u2192 Exit to manual setup (conversation pauses)\n    \u2192 User configures in full UI\n\n// Draft configs pattern:\n- All configs created with onboardingDraft: true\n- Finalized only at beezaroAssistants completion\n- Allows deletion/recreation during edits\n'})}),"\n",(0,a.jsx)(n.h3,{id:"ai-assistant-assignment-flow",children:"AI Assistant Assignment Flow"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Pattern: Strategy \u2192 Create Assistants \u2192 Assign to Channels \u2192 Confirm\n\nFlow:\n1. aiAssistantsForChannels (choice)\n   Options: "single" | "multiple"\n   \u2193\n2. Backend determines count:\n   if (strategy === "single") {\n     assistantCount = 1\n   } else {\n     assistantCount = selected_channel_values.length\n   }\n   \u2193\n3. Backend validates against plan.maxAiAssistants\n   \u2193\n4. Backend creates draft assistants:\n   for (i = 0; i < assistantCount; i++) {\n     await prisma.aiAssistant.create({\n       name: `Beezaro ${suffix[i]}`,\n       tone: getIndustryTone(industry),\n       onboardingDraft: true,  // CRITICAL FLAG\n       ...\n     })\n   }\n   \u2193\n5. Backend computes channel assignments:\n   const assignments = computeDraftAssignments(channelIds, assistantIds)\n\n   Logic:\n   - Single assistant \u2192 all channels use same assistant\n   - Multiple assistants >= channels \u2192 1:1 mapping\n   - Multiple assistants < channels \u2192 first N-1 get 1:1, last gets remainder\n   \u2193\n6. Backend creates draft configs:\n   for (assignment of assignments) {\n     await prisma.channelAiConfig.create({\n       connectedChannelId: assignment.connectedChannelId,\n       aiAssistantId: assignment.aiAssistantId,\n       onboardingDraft: true,  // CRITICAL FLAG\n       // ... escalation, followUp settings from recommendations or fallback\n     })\n   }\n   \u2193\n7. Stores in collected_data:\n   - created_assistants: [{ id, name }]\n   - draft_channel_configs: [{ channelAiConfigId, connectedChannelId, aiAssistantId, ... }]\n   \u2193\n8. beezaroAssistants (choice)\n   Displays assistant cards\n   Options: "yes" (finalize) | "no" (manual setup)\n   User can add/delete assistants at this step\n   \u2193\n9. On "yes":\n   - Sets onboardingDraft: false on all assistants\n   - Sets onboardingDraft: false on all configs\n   - Advances to automation section\n\n   On "no":\n   - Finalizes same way\n   - Exits to manual setup\n\n// Assignment recomputation:\n- Triggered on assistant add/delete\n- Uses same computeDraftAssignments() logic\n- Updates all draft_channel_configs\n'})}),"\n",(0,a.jsx)(n.h3,{id:"automation-selection-flow",children:"Automation Selection Flow"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Pattern: Optional Selection \u2192 Sub-Select \u2192 Confirm OR Skip\n\nFlow:\n1. addAutomations (choice with sub-select)\n   Options:\n   - "yes" \u2192 hasSubselect: true\n     Sub-options:\n     - "Tag new leads"\n     - "Follow-up after 24h"\n     - "Send welcome message"\n   - "no" \u2192 nextSubstepId: "finalizeSetup"\n   \u2193\n2a. User selects "no"\n    - Sets addAutomations: false\n    - Skips confirmAIAutomations\n    - Advances to finalizeSetup\n\n2b. User selects "yes" + sub-options\n    - Validates: subSelectValues.length > 0\n    - Stores selected_automations: ["tagNewLeads", "followUp"]\n    - Advances to confirmAIAutomations\n    \u2193\n3. confirmAIAutomations (choice)\n   Options: "Confirm and continue" (true) | "View in manual setup" (false)\n   \u2193\n4a. User confirms\n    - Creates automation records from AUTOMATION_PRESETS\n    - Marks conversation complete\n\n4b. User selects manual\n    - Exits to manual setup\n    - Conversation marked complete\n\n// Automation creation:\n- Only happens at confirmAIAutomations confirmation\n- Uses predefined presets from AUTOMATION_PRESETS map\n- Creates in default campaign: "Copilot Onboarding Automations"\n'})}),"\n",(0,a.jsx)(n.h2,{id:"state-synchronization-patterns",children:"State Synchronization Patterns"}),"\n",(0,a.jsx)(n.h3,{id:"when-frontend-should-call-get-state",children:"When Frontend Should Call GET /state"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// REQUIRED scenarios:\n1. Page load/refresh\n   - Always sync on mount\n   - Prevents stale state rendering\n\n2. After validation error with sync hint\n   Error: { hint: "Please call GET /copilot/state to sync..." }\n\n3. Before rendering dynamic substeps\n   - channels, adjustGoalsObjectives (always)\n   - selectBusinessNameMatch (if options missing)\n\n4. After assistant add/delete (if outside conversation)\n   - Response has uiDirectives.refreshAssistants\n\n5. After external state changes\n   - Plan upgrades outside copilot\n   - Channel additions outside copilot\n\n// OPTIONAL but recommended:\n1. After long idle periods (>5 minutes)\n2. Before edit operations (verify current position)\n3. On browser back/forward navigation\n\n// NOT NEEDED:\n1. After successful POST /copilot/message (response includes full state)\n2. During normal flow progression (server advances position)\n3. Immediately after POST /copilot/start (response includes initial state)\n'})}),"\n",(0,a.jsx)(n.h3,{id:"optimistic-updates-pattern",children:"Optimistic Updates Pattern"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:"// \u274c DON'T DO THIS (server is source of truth):\nonClick={() => {\n  // Optimistically advance to next substep\n  setCurrentSubstep(nextSubstep)\n\n  POST /copilot/message\n    .then(res => {\n      // Might not match optimistic update!\n    })\n}\n\n// \u2705 DO THIS (wait for server confirmation):\nonClick={async () => {\n  setLoading(true)\n\n  try {\n    const res = await POST /copilot/message\n\n    // Server tells us exact next state\n    setCurrentSubstep(res.currentSubstep)\n    setCurrentSection(res.currentSubstep.parentStepId)\n\n    // Update history if provided\n    if (res.lastUserMessage) {\n      addToHistory(res.lastUserMessage)\n    }\n\n  } catch (error) {\n    // Show error, don't advance state\n    showError(error.message)\n  } finally {\n    setLoading(false)\n  }\n}\n\n// Why: Backend may:\n// - Navigate to different substep than expected (validation, branching)\n// - Trigger section completion (isEndOfStep)\n// - Enter edit flow (affected substeps)\n// - Mark conversation complete\n"})}),"\n",(0,a.jsx)(n.h3,{id:"state-reconciliation-on-errors",children:"State Reconciliation on Errors"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Pattern for handling state drift:\n\ntry {\n  (await POST) / copilot / message;\n} catch (error) {\n  if (error.status === 400) {\n    // Validation error - check for sync hint\n    if (error.hint?.includes("call GET /copilot/state")) {\n      // State is out of sync - resync\n      const freshState = (await GET) / copilot / state;\n\n      // Update local state to match server\n      setCurrentSection(freshState.currentSection);\n      setCurrentSubstep(freshState.currentSubstep);\n      setSessionState(freshState.sessionState);\n\n      // Show user-friendly message\n      showToast("Your position was updated. Please try again.");\n    } else {\n      // Regular validation error - show to user\n      showValidationErrors(error.errors || [error.message]);\n    }\n  } else {\n    // Network or server error - don\'t change state\n    showError("Something went wrong. Please try again.");\n  }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"completion--terminal-states",children:"Completion & Terminal States"}),"\n",(0,a.jsx)(n.h3,{id:"conversation-completion-detection",children:"Conversation Completion Detection"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Conversation is complete when:\nResponse: {\n  currentSubstep: null,\n  conversationComplete: true,\n  uiDirectives: {}\n}\n\n// Triggers:\n1. automation section completes:\n   - User confirms automations at confirmAIAutomations\n   - User confirms at finalizeSetup\n\n2. User exits to manual setup:\n   - Any "View in manual setup" or "Configure now" option\n   - Response has uiDirectives.exitToManualSetup: true\n\n// Backend action:\nawait stateService.completeConversation(conversationId)\n// Sets: conversation.isActive = false, completedAt = now()\n\n// Frontend action:\nif (response.conversationComplete) {\n  // Navigate to dashboard or manual setup\n  router.push(response.uiDirectives.exitToManualSetup\n    ? "/channels/configure"\n    : "/dashboard"\n  )\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"section-completion-detection",children:"Section Completion Detection"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Section is complete when:\nResponse: {\n  currentSubstep: { ... },  // Next section\'s entry substep\n  sectionComplete: true,\n  uiDirectives: { ... }\n}\n\n// Triggers:\n- Last substep in section completed\n- substep.isEndOfStep === true\n- No nextSubstepId available\n\n// Backend action:\nawait stateService.markSectionComplete(conversationId, sectionId)\n// Adds to: conversation.sessionState.completed_sections\n\n// Frontend action (optional):\nif (response.sectionComplete) {\n  // Show progress indicator update\n  updateProgressBar(completedSections.length, totalSections)\n\n  // Optional celebration animation\n  if (sectionId === "businessIdentity") {\n    showAnimation("Business profile complete!")\n  }\n}\n\n// Note: Section completion doesn\'t pause flow\n// User automatically advances to next section entry point\n'})}),"\n",(0,a.jsx)(n.h3,{id:"substep-skip-vs-complete",children:"Substep Skip vs Complete"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Completed substeps:\n// - User provided input and advanced\n// - Stored in state.completed_substeps\n// - Can be edited later (if canEdit: true)\n\n// Skipped substeps:\n// - User explicitly skipped via POST /copilot/skip\n// - OR substep was bypassed due to branching\n// - Stored in state.skipped_substeps\n// - Cannot be edited (no data collected)\n\n// Example skipped scenarios:\n1. categoryNotListed - skipped if user picks valid industry\n2. businessNotListed - skipped if user picks business match\n3. teamSizeOverLimit - skipped if size within plan limits\n4. adjustGoalsObjectives - skipped if user doesn\'t select "adjust"\n5. confirmAIAutomations - skipped if user selects "no" to automations\n\n// Validation impact:\n// Prerequisites check both completed AND skipped:\nconst validSubsteps = [\n  ...state.completed_substeps,\n  ...state.skipped_substeps\n]\n// If prerequisite not in validSubsteps \u2192 validation fails\n'})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Phase 1, Section B Complete"})}),"\n",(0,a.jsx)(n.p,{children:"This section covered:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u2705 Complete flow hierarchy and navigation rules"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 State transition logic with 7-phase validation"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 collected_data field reference and lifecycle"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Dynamic option hydration patterns"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 All special flow patterns (search, team size, channels, assistants, automation)"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 State synchronization best practices"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Completion and terminal state handling"}),"\n"]}),"\n",(0,a.jsx)(n.h1,{id:"supplementary-documentation",children:"Supplementary Documentation"}),"\n",(0,a.jsx)(n.h2,{id:"edge-cases-matrix",children:"Edge Cases Matrix"}),"\n",(0,a.jsx)(n.h3,{id:"comprehensive-edge-case-reference",children:"Comprehensive Edge Case Reference"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// LEGEND:\n// \u2705 Handled automatically by backend\n// \u26a0\ufe0f Requires frontend awareness\n// \ud83d\udd34 Blocked with error\n// \ud83d\udd04 Triggers special flow\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         NORMAL FLOW EDGE CASES                              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Scenario                 \u2502 Behavior                 \u2502 Frontend Action        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Empty business search    \u2502 \u2705 Returns empty array   \u2502 Show "not listed"      \u2502\n\u2502 results                  \u2502 selectBusinessNameMatch  \u2502 prominently            \u2502\n\u2502                          \u2502 shows only "not listed"  \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Team size exceeds plan   \u2502 \ud83d\udd04 Navigates to          \u2502 Follow upgrade flow    \u2502\n\u2502 limit                    \u2502 teamSizeOverLimit        \u2502 or select smaller size \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Channel requires addon   \u2502 \ud83d\udd34 Validation error      \u2502 Show upgrade message   \u2502\n\u2502 not in plan              \u2502 requiresUpgrade: true    \u2502 with plan details      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Last assistant deleted   \u2502 \ud83d\udd34 BadRequest error      \u2502 Disable delete button  \u2502\n\u2502                          \u2502 "Cannot delete last"     \u2502 when count === 1       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Logo upload with         \u2502 \u2705 Replaces matched data \u2502 Show confirmation      \u2502\n\u2502 existing business        \u2502 selected_business.logo   \u2502 before upload          \u2502\n\u2502                          \u2502 updated                  \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Sub-select without       \u2502 \ud83d\udd34 Validation error      \u2502 Validate before submit \u2502\n\u2502 parent selection         \u2502 "subSelectValues missing"\u2502 show inline error      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Late session sync        \u2502 \u26a0\ufe0f substepId mismatch    \u2502 Call GET /state        \u2502\n\u2502 (page refresh)           \u2502 error with hint          \u2502 on mount, before submit\u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Skip substep vs complete \u2502 \u2705 Different tracking    \u2502 UI shows skip \u2260 edit   \u2502\n\u2502                          \u2502 skipped_substeps vs      \u2502 Skipped = no edit btn  \u2502\n\u2502                          \u2502 completed_substeps       \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Multiple channel         \u2502 \u2705 Creates all, reports  \u2502 Show success count +   \u2502\n\u2502 selections with errors   \u2502 channelValidations array \u2502 any failures           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 AI assistant count       \u2502 \ud83d\udd04 Caps at plan limit    \u2502 Show warning if capped \u2502\n\u2502 exceeds plan limit       \u2502 Logs warning, continues  \u2502 "Created N of M"       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Business name with       \u2502 \u2705 Sanitized by backend  \u2502 Show sanitized version \u2502\n\u2502 special characters       \u2502 validateTextInput()      \u2502 after submission       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Industry "none" selected \u2502 \ud83d\udd04 Navigates to          \u2502 Provide text input for \u2502\n\u2502                          \u2502 categoryNotListed        \u2502 custom industry        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 LLM goal generation      \u2502 \u2705 Falls back to default \u2502 Display goals normally \u2502\n\u2502 fails                    \u2502 goals if LLM fails       \u2502 (user doesn\'t see diff)\u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Automation selection:    \u2502 \u2705 Skips to finalizeSetup\u2502 Handle both paths      \u2502\n\u2502 "No, skip"               \u2502 Clears selected_automations                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Exit to manual setup     \u2502 \u2705 Returns currentSubstep\u2502 Navigate to manual UI  \u2502\n\u2502                          \u2502 = null, exitToManualSetup\u2502 /channels/configure    \u2502\n\u2502                          \u2502 = true                   \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Section complete during  \u2502 \u2705 Auto-advances to next \u2502 Show progress update   \u2502\n\u2502 normal flow              \u2502 section entry substep    \u2502 animate transition     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Conversation complete    \u2502 \u2705 Returns currentSubstep\u2502 Redirect to dashboard  \u2502\n\u2502                          \u2502 = null, conversationComplete = true                \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Dynamic options missing  \u2502 \u26a0\ufe0f Options array empty   \u2502 Call GET /state to     \u2502\n\u2502 (channels, goals)        \u2502 or undefined             \u2502 trigger hydration      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Duplicate channel        \u2502 \u2705 Marked alreadyExists  \u2502 Show "already added"   \u2502\n\u2502 selection                \u2502 in channelValidations    \u2502 message, no error      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 File upload > 5MB        \u2502 \ud83d\udd34 BadRequest error      \u2502 Validate client-side   \u2502\n\u2502                          \u2502 "File size must be..."   \u2502 before upload          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 File upload wrong type   \u2502 \ud83d\udd34 BadRequest error      \u2502 Validate client-side   \u2502\n\u2502 (e.g., PDF for logo)     \u2502 "Only PNG, JPG, WEBP..." \u2502 accept="image/*"       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                          EDIT FLOW EDGE CASES                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Scenario                 \u2502 Behavior                 \u2502 Frontend Action        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Edit during active edit  \u2502 \ud83d\udd34 BadRequest error      \u2502 Disable edit buttons   \u2502\n\u2502 (nested edit)            \u2502 "Cannot edit while in    \u2502 when isInEditFlow=true \u2502\n\u2502                          \u2502 edit flow"               \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Edit non-editable        \u2502 \ud83d\udd34 BadRequest error      \u2502 Hide edit button if    \u2502\n\u2502 substep (canEdit: false) \u2502 "This substep cannot be  \u2502 substep.canEdit=false  \u2502\n\u2502                          \u2502 edited"                  \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Edit incomplete substep  \u2502 \ud83d\udd34 BadRequest error      \u2502 Only show edit for     \u2502\n\u2502                          \u2502 "Cannot edit incomplete  \u2502 completed substeps     \u2502\n\u2502                          \u2502 substep"                 \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Edit with plan downgrade \u2502 \u2705 Revalidation cascade  \u2502 Show affected substeps \u2502\n\u2502                          \u2502 Clears invalidated data  \u2502 that need completion   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Cross-section edit       \u2502 \u2705 Sets edit context     \u2502 Show edit breadcrumb   \u2502\n\u2502 return                   \u2502 Navigates to affected    \u2502 "Editing X, return to Y"\u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Edit invalidates future  \u2502 \u2705 Clears multiple       \u2502 Show which sections    \u2502\n\u2502 sections                 \u2502 substeps across sections \u2502 need re-completion     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Edit "not listed" after  \u2502 \u2705 Switches to manual    \u2502 Show logo upload UI    \u2502\n\u2502 business match           \u2502 Clears selected_business \u2502 Clear business data    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Team size edit requiring \u2502 \ud83d\udd04 Navigates to upgrade  \u2502 Follow upgrade flow    \u2502\n\u2502 upgrade                  \u2502 flow (teamSizeOverLimit) \u2502 then return            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Channel edit removes     \u2502 \u2705 Auto cleanup + rebuild\u2502 Refresh assistant list \u2502\n\u2502 channels with assistants \u2502 Deletes configs & channel\u2502 Show reassignment msg  \u2502\n\u2502                          \u2502 Reassigns remaining      \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Industry edit triggers   \u2502 \u2705 LLM regenerates goals \u2502 Show loading during    \u2502\n\u2502 goal regeneration        \u2502 Clears old goals         \u2502 regeneration           \u2502\n\u2502                          \u2502 Navigates to confirm     \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Business name edit       \u2502 \u2705 New search performed  \u2502 Show search results    \u2502\n\u2502 from later section       \u2502 Clears old match + goals \u2502 Navigate to match      \u2502\n\u2502                          \u2502 Sets edit context        \u2502 selection              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Logo edit replaces       \u2502 \u2705 Deletes old from S3   \u2502 Show upload progress   \u2502\n\u2502 existing logo            \u2502 Uploads new              \u2502 Update preview         \u2502\n\u2502                          \u2502 Updates URL in state     \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Channel config strategy  \u2502 \u2705 Cleans all drafts     \u2502 If manual: exit to UI  \u2502\n\u2502 edit (rec \u2192 manual)      \u2502 Sets exit flag           \u2502 If rec: rebuild flow   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Assistant strategy edit  \u2502 \u2705 Deletes all assistants\u2502 Show loading           \u2502\n\u2502 (single \u2192 multiple)      \u2502 Creates new count        \u2502 Display new assistants \u2502\n\u2502                          \u2502 Recomputes assignments   \u2502                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Return position invalid  \u2502 \u2705 Logs error, clears    \u2502 Shouldn\'t happen       \u2502\n\u2502 (flow config changed)    \u2502 Falls back to normal flow\u2502 Handle gracefully      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Edit during upgrade flow \u2502 \ud83d\udd34 Blocked               \u2502 Disable edit during    \u2502\n\u2502                          \u2502 "Complete current edit"  \u2502 upgrade substeps       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Multiple edits to same   \u2502 \u2705 Each tracked in       \u2502 Show edit count badge  \u2502\n\u2502 substep                  \u2502 edit_history             \u2502 "Edited 2 times"       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Edit after conversation  \u2502 \ud83d\udd34 Not found error       \u2502 Don\'t show edit after  \u2502\n\u2502 complete                 \u2502 "No active conversation" \u2502 completion             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Channels edit adds >     \u2502 \ud83d\udd34 Plan validation error \u2502 Show plan upgrade      \u2502\n\u2502 plan limit               \u2502 requiresUpgrade: true    \u2502 before allowing        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      STATE SYNCHRONIZATION EDGE CASES                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Scenario                 \u2502 Behavior                 \u2502 Frontend Action        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Page refresh mid-flow    \u2502 \u26a0\ufe0f State persists in DB  \u2502 GET /state on mount    \u2502\n\u2502                          \u2502 Frontend needs resync    \u2502 Restore UI from state  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Browser back/forward     \u2502 \u26a0\ufe0f May show stale UI     \u2502 GET /state on popstate \u2502\n\u2502                          \u2502 Server state unchanged   \u2502 Resync position        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Concurrent requests      \u2502 \u2705 Last write wins       \u2502 Disable submit during  \u2502\n\u2502 (double click)           \u2502 Database handles         \u2502 pending request        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Network timeout          \u2502 \u26a0\ufe0f May be processed      \u2502 Don\'t retry auto       \u2502\n\u2502                          \u2502 Server may have saved    \u2502 Show "Check status"    \u2502\n\u2502                          \u2502                          \u2502 Call GET /state        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 substepId mismatch       \u2502 \ud83d\udd34 Validation error      \u2502 Resync via GET /state  \u2502\n\u2502                          \u2502 "expected X, received Y" \u2502 Don\'t allow submission \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Stale options data       \u2502 \u26a0\ufe0f May select invalid    \u2502 GET /state before      \u2502\n\u2502 (channels changed)       \u2502 Backend validates        \u2502 rendering options      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Session expiry mid-flow  \u2502 \ud83d\udd34 401 Unauthorized      \u2502 Redirect to login      \u2502\n\u2502                          \u2502 State preserved          \u2502 Resume after reauth    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Optimistic update fails  \u2502 \u26a0\ufe0f UI out of sync        \u2502 DON\'T use optimistic   \u2502\n\u2502                          \u2502 Server is source of truth\u2502 Wait for response      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Long idle (>30 min)      \u2502 \u2705 State persists        \u2502 Optional: GET /state   \u2502\n\u2502                          \u2502 Session may expire       \u2502 before next action     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 External plan change     \u2502 \u26a0\ufe0f State may be invalid  \u2502 GET /state after       \u2502\n\u2502 (via settings page)      \u2502 Not auto-revalidated     \u2502 returning to copilot   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 External channel add     \u2502 \u26a0\ufe0f Not reflected         \u2502 GET /state to refresh  \u2502\n\u2502 (via manual UI)          \u2502 until resync             \u2502 available channels     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Multiple tabs open       \u2502 \u26a0\ufe0f Each has own state    \u2502 Detect with storage    \u2502\n\u2502                          \u2502 Last action wins         \u2502 Warn user or disable   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,a.jsx)(n.h2,{id:"code-examples--integration-snippets",children:"Code Examples & Integration Snippets"}),"\n",(0,a.jsx)(n.h3,{id:"example-1-complete-message-send-flow",children:"Example 1: Complete Message Send Flow"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// \u2705 CORRECT: Full error handling with state sync\n\nimport { useState } from "react";\nimport { CopilotResponseDto, SendMessageDto } from "./types";\n\nfunction CopilotFlow() {\n  const [currentSubstep, setCurrentSubstep] = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n\n  async function handleSubmit(\n    inputType: string,\n    content: string,\n    metadata: any\n  ) {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const messageDto: SendMessageDto = {\n        inputType,\n        content,\n        metadata: {\n          ...metadata,\n          substepId: currentSubstep.id, // CRITICAL: Must match current position\n        },\n      };\n\n      const response: CopilotResponseDto = await fetch("/api/copilot/message", {\n        method: "POST",\n        headers: { "Content-Type": "application/json" },\n        body: JSON.stringify(messageDto),\n      }).then((res) => {\n        if (!res.ok) throw res;\n        return res.json();\n      });\n\n      // Handle completion states\n      if (response.conversationComplete) {\n        router.push(\n          response.uiDirectives?.exitToManualSetup\n            ? "/channels/configure"\n            : "/dashboard"\n        );\n        return;\n      }\n\n      // Update local state from server response\n      setCurrentSubstep(response.currentSubstep);\n\n      // Render components\n      if (response.uiDirectives?.components) {\n        renderComponents(response.uiDirectives.components);\n      }\n\n      // Add to message history\n      if (response.lastUserMessage) {\n        addToHistory(response.lastUserMessage);\n      }\n\n      // Show section completion celebration\n      if (response.sectionComplete) {\n        showToast(`${currentSubstep.parentStepId} section complete!`);\n      }\n    } catch (err) {\n      if (err.status === 400) {\n        const errorData = await err.json();\n\n        // Check for sync error\n        if (errorData.hint?.includes("call GET /copilot/state")) {\n          // Resync state\n          const freshState = await fetch("/api/copilot/state").then((r) =>\n            r.json()\n          );\n          setCurrentSubstep(freshState.currentSubstepDetails.currentSubstep);\n\n          setError("Your position was updated. Please try again.");\n        } else {\n          // Regular validation error\n          setError(errorData.message);\n\n          // Show field-specific errors if available\n          if (errorData.errors) {\n            showValidationErrors(errorData.errors);\n          }\n        }\n      } else if (err.status === 401) {\n        // Session expired\n        router.push("/login?redirect=/copilot");\n      } else {\n        // Network or server error\n        setError("Something went wrong. Please try again.");\n      }\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  // ... render UI\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"example-2-dynamic-option-hydration",children:"Example 2: Dynamic Option Hydration"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// \u2705 CORRECT: Fetch fresh state for dynamic substeps\n\nfunction DynamicSubstepRenderer({ substep }) {\n  const [options, setOptions] = useState(substep.options || []);\n  const [loading, setLoading] = useState(false);\n\n  useEffect(() => {\n    // Check if substep needs dynamic options\n    const needsHydration = [\n      "businessIndustry",\n      "channels",\n      "adjustGoalsObjectives",\n      "selectBusinessNameMatch",\n    ].includes(substep.id);\n\n    if (needsHydration && (!substep.options || substep.options.length === 0)) {\n      // Fetch fresh state to hydrate options\n      refreshOptions();\n    }\n  }, [substep.id]);\n\n  async function refreshOptions() {\n    setLoading(true);\n\n    try {\n      const state = await fetch("/api/copilot/state").then((r) => r.json());\n      const freshSubstep = state.currentSubstepDetails.currentSubstep;\n\n      if (freshSubstep.id === substep.id) {\n        setOptions(freshSubstep.options);\n      }\n    } catch (err) {\n      console.error("Failed to refresh options:", err);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  if (loading) {\n    return <Spinner />;\n  }\n\n  return <OptionsList options={options} onSelect={handleSelect} />;\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"example-3-edit-flow-with-context-awareness",children:"Example 3: Edit Flow with Context Awareness"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// \u2705 CORRECT: Edit handling with return flow support\n\nfunction EditButton({ substep, currentSection, value }) {\n  const [isEditing, setIsEditing] = useState(false);\n\n  // Don\'t show edit button if:\n  // 1. Substep not completed\n  // 2. canEdit is false\n  // 3. Currently in edit flow (prevent nested edits)\n  const canEdit =\n    substep.isComplete && substep.canEdit !== false && !isInEditFlow;\n\n  if (!canEdit) return null;\n\n  async function handleEdit(newValue: any) {\n    setIsEditing(true);\n\n    try {\n      const response = await fetch(`/api/copilot/edit/${substep.id}`, {\n        method: "POST",\n        headers: { "Content-Type": "application/json" },\n        body: JSON.stringify({\n          substepId: substep.id,\n          newValue,\n        }),\n      }).then((r) => {\n        if (!r.ok) throw r;\n        return r.json();\n      });\n\n      // Handle different edit response patterns\n      if (response.uiDirectives?.isInEditFlow) {\n        // Cross-section edit - navigate to affected substep\n        setEditContext({\n          editedSubstep: substep.id,\n          editedSection: currentSection,\n          affectedSubsteps: response.uiDirectives.editContext.affectedSubsteps,\n          returnPosition: { section: currentSection, substep: substep.id },\n        });\n\n        setCurrentSubstep(response.currentSubstep);\n\n        // Show breadcrumb\n        showEditBreadcrumb(\n          `Editing ${substep.name}`,\n          `Will return to ${currentSection}`\n        );\n      } else if (response.uiDirectives?.editComplete) {\n        // Edit complete - inline or same section\n        if (response.uiDirectives?.returnedFromEdit) {\n          // Returned from cross-section edit\n          clearEditContext();\n          showToast("Edit complete - returned to your original position");\n        } else {\n          // Inline edit\n          showToast("Updated successfully");\n        }\n\n        // Update current substep if navigated\n        if (response.currentSubstep) {\n          setCurrentSubstep(response.currentSubstep);\n        }\n      } else if (response.uiDirectives?.exitToManualSetup) {\n        // Switched to manual setup\n        router.push("/channels/configure");\n      }\n    } catch (err) {\n      const errorData = await err.json();\n\n      if (errorData.message?.includes("Cannot edit while in edit flow")) {\n        showError(\n          "Please complete your current edit before starting a new one"\n        );\n      } else {\n        showError(errorData.message || "Failed to edit");\n      }\n    } finally {\n      setIsEditing(false);\n    }\n  }\n\n  return (\n    <button onClick={() => handleEdit(/* new value */)} disabled={isEditing}>\n      {isEditing ? "Saving..." : "Edit"}\n    </button>\n  );\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"example-4-file-upload-with-validation",children:"Example 4: File Upload with Validation"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// \u2705 CORRECT: Client-side validation + progress tracking\n\nfunction LogoUpload({ substepId }) {\n  const [uploading, setUploading] = useState(false);\n  const [progress, setProgress] = useState(0);\n\n  async function handleFileSelect(file: File) {\n    // Client-side validation\n    const validTypes = ["image/png", "image/jpeg", "image/jpg", "image/webp"];\n    const maxSize = 5 * 1024 * 1024; // 5MB\n\n    if (!validTypes.includes(file.type)) {\n      showError("Please upload a PNG, JPG, or WEBP image");\n      return;\n    }\n\n    if (file.size > maxSize) {\n      showError(\n        `File size must be under 5MB (current: ${(\n          file.size /\n          1024 /\n          1024\n        ).toFixed(2)}MB)`\n      );\n      return;\n    }\n\n    setUploading(true);\n    setProgress(0);\n\n    try {\n      const formData = new FormData();\n      formData.append("logo", file);\n      formData.append("substepId", substepId);\n\n      const xhr = new XMLHttpRequest();\n\n      // Track upload progress\n      xhr.upload.addEventListener("progress", (e) => {\n        if (e.lengthComputable) {\n          setProgress((e.loaded / e.total) * 100);\n        }\n      });\n\n      const response = await new Promise<CopilotResponseDto>(\n        (resolve, reject) => {\n          xhr.onload = () => {\n            if (xhr.status === 200) {\n              resolve(JSON.parse(xhr.responseText));\n            } else {\n              reject(JSON.parse(xhr.responseText));\n            }\n          };\n          xhr.onerror = () => reject(new Error("Upload failed"));\n\n          xhr.open("POST", "/api/copilot/upload-logo");\n          xhr.send(formData);\n        }\n      );\n\n      // Update UI with new logo\n      if (response.uiDirectives?.components) {\n        const logoComponent = response.uiDirectives.components.find(\n          (c) => c.name === "businessLogo"\n        );\n        if (logoComponent) {\n          setLogoUrl(logoComponent.metadata.logoUrl);\n        }\n      }\n\n      showToast("Logo uploaded successfully");\n    } catch (err) {\n      showError(err.message || "Upload failed");\n    } finally {\n      setUploading(false);\n      setProgress(0);\n    }\n  }\n\n  return (\n    <div>\n      <input\n        type="file"\n        accept="image/png,image/jpeg,image/jpg,image/webp"\n        onChange={(e) => handleFileSelect(e.target.files[0])}\n        disabled={uploading}\n      />\n      {uploading && (\n        <ProgressBar\n          value={progress}\n          label={`Uploading... ${progress.toFixed(0)}%`}\n        />\n      )}\n    </div>\n  );\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"example-5-assistant-adddelete-with-optimistic-ui",children:"Example 5: Assistant Add/Delete with Optimistic UI"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// \u2705 CORRECT: Optimistic UI with rollback on error\n\nfunction AssistantList({ assistants, isConversational }) {\n  const [localAssistants, setLocalAssistants] = useState(assistants);\n  const [pendingOps, setPendingOps] = useState<Set<number>>(new Set());\n\n  async function handleAddAssistant() {\n    // Optimistic: Add temporary assistant immediately\n    const tempId = Date.now();\n    const tempAssistant = {\n      id: tempId,\n      name: "Creating...",\n      temporary: true,\n    };\n\n    setLocalAssistants((prev) => [...prev, tempAssistant]);\n    setPendingOps((prev) => new Set(prev).add(tempId));\n\n    try {\n      const response = await fetch("/api/copilot/assistants", {\n        method: "POST",\n      }).then((r) => r.json());\n\n      if (isConversational && response.currentSubstep) {\n        // Update from bot message (assistant cards)\n        const assistantCards = response.currentSubstep.botMessage\n          .filter((m) => m.component === "AssistantCard")\n          .map((m) => m.metadata);\n\n        setLocalAssistants(assistantCards);\n      } else if (response.uiDirectives?.assistantMutation) {\n        // Update from mutation data\n        setLocalAssistants(\n          response.uiDirectives.assistantMutation.createdAssistants\n        );\n      }\n    } catch (err) {\n      // Rollback optimistic update\n      setLocalAssistants((prev) => prev.filter((a) => a.id !== tempId));\n      showError("Failed to add assistant");\n    } finally {\n      setPendingOps((prev) => {\n        const next = new Set(prev);\n        next.delete(tempId);\n        return next;\n      });\n    }\n  }\n\n  async function handleDeleteAssistant(assistantId: number) {\n    // Prevent deleting last assistant\n    if (localAssistants.length === 1) {\n      showError("Cannot delete the last assistant");\n      return;\n    }\n\n    // Optimistic: Remove immediately\n    const backup = localAssistants;\n    setLocalAssistants((prev) => prev.filter((a) => a.id !== assistantId));\n    setPendingOps((prev) => new Set(prev).add(assistantId));\n\n    try {\n      const response = await fetch(`/api/copilot/assistants/${assistantId}`, {\n        method: "DELETE",\n      }).then((r) => r.json());\n\n      // Update from response\n      if (response.currentSubstep?.botMessage) {\n        const assistantCards = response.currentSubstep.botMessage\n          .filter((m) => m.component === "AssistantCard")\n          .map((m) => m.metadata);\n\n        setLocalAssistants(assistantCards);\n      }\n    } catch (err) {\n      // Rollback\n      setLocalAssistants(backup);\n      showError("Failed to delete assistant");\n    } finally {\n      setPendingOps((prev) => {\n        const next = new Set(prev);\n        next.delete(assistantId);\n        return next;\n      });\n    }\n  }\n\n  return (\n    <div>\n      {localAssistants.map((assistant) => (\n        <AssistantCard\n          key={assistant.id}\n          assistant={assistant}\n          onDelete={handleDeleteAssistant}\n          deleting={pendingOps.has(assistant.id)}\n          canDelete={localAssistants.length > 1}\n        />\n      ))}\n      <button onClick={handleAddAssistant}>Add Assistant</button>\n    </div>\n  );\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"example-6-state-persistence--recovery",children:"Example 6: State Persistence & Recovery"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// \u2705 CORRECT: Handle page refresh and browser navigation\n\nfunction CopilotProvider({ children }) {\n  const [state, setState] = useState(null);\n  const [loading, setLoading] = useState(true);\n\n  // On mount: Restore state from server\n  useEffect(() => {\n    async function restoreState() {\n      try {\n        const response = await fetch("/api/copilot/state").then((r) =>\n          r.json()\n        );\n\n        setState({\n          conversationId: response.conversationId,\n          currentSection: response.currentSection,\n          currentSubstep: response.currentSubstepDetails.currentSubstep,\n          sessionState: response.sessionState,\n          isActive: response.isActive,\n          isCompleted: response.isCompleted,\n          messageHistory: response.recentMessages,\n        });\n\n        // Check if conversation is complete\n        if (response.isCompleted) {\n          router.push("/dashboard");\n          return;\n        }\n      } catch (err) {\n        if (err.status === 404) {\n          // No active conversation - start new one\n          const startResponse = await fetch("/api/copilot/start", {\n            method: "POST",\n          }).then((r) => r.json());\n\n          setState({\n            currentSubstep: startResponse.currentSubstep,\n            // ... initialize state\n          });\n        } else {\n          showError("Failed to restore conversation state");\n        }\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    restoreState();\n  }, []);\n\n  // Handle browser back/forward\n  useEffect(() => {\n    function handlePopState() {\n      // Resync state on navigation\n      fetch("/api/copilot/state")\n        .then((r) => r.json())\n        .then((response) => {\n          setState((prev) => ({\n            ...prev,\n            currentSubstep: response.currentSubstepDetails.currentSubstep,\n            currentSection: response.currentSection,\n          }));\n        });\n    }\n\n    window.addEventListener("popstate", handlePopState);\n    return () => window.removeEventListener("popstate", handlePopState);\n  }, []);\n\n  // Prevent multiple tabs\n  useEffect(() => {\n    const tabId = sessionStorage.getItem("copilot-tab-id");\n\n    if (tabId && tabId !== window.name) {\n      showWarning(\n        "Copilot is already open in another tab. Changes may conflict."\n      );\n    } else {\n      window.name = Date.now().toString();\n      sessionStorage.setItem("copilot-tab-id", window.name);\n    }\n\n    return () => {\n      sessionStorage.removeItem("copilot-tab-id");\n    };\n  }, []);\n\n  if (loading) {\n    return <LoadingScreen />;\n  }\n\n  return (\n    <CopilotContext.Provider value={state}>{children}</CopilotContext.Provider>\n  );\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"troubleshooting-guide",children:"Troubleshooting Guide"}),"\n",(0,a.jsx)(n.h3,{id:"common-issues--solutions",children:"Common Issues & Solutions"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Issue: "Validation failed - substepId mismatch"                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Cause: Frontend and backend are out of sync                                \u2502\n\u2502                                                                             \u2502\n\u2502 Symptoms:                                                                   \u2502\n\u2502 \u2022 Error message: "expected confirmBusinessData, received businessName"     \u2502\n\u2502 \u2022 Occurs after page refresh or navigation                                  \u2502\n\u2502                                                                             \u2502\n\u2502 Solution:                                                                   \u2502\n\u2502 1. Call GET /copilot/state on component mount                              \u2502\n\u2502 2. Use state.currentSubstep.id for metadata.substepId                      \u2502\n\u2502 3. Never hardcode substep IDs                                              \u2502\n\u2502                                                                             \u2502\n\u2502 Prevention:                                                                 \u2502\n\u2502 \u2022 Always sync state before user interaction                                \u2502\n\u2502 \u2022 Implement popstate listener for browser back/forward                     \u2502\n\u2502 \u2022 Add state version checking                                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Issue: Options array is empty for dynamic substeps                         \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Cause: Options not hydrated (channels, goals, etc.)                        \u2502\n\u2502                                                                             \u2502\n\u2502 Symptoms:                                                                   \u2502\n\u2502 \u2022 substep.options = [] or undefined                                        \u2502\n\u2502 \u2022 Occurs for: channels, adjustGoalsObjectives, selectBusinessNameMatch     \u2502\n\u2502                                                                             \u2502\n\u2502 Solution:                                                                   \u2502\n\u2502 1. Check if substep needs hydration:                                       \u2502\n\u2502    const needsHydration = [\'channels\', \'adjustGoalsObjectives\',            \u2502\n\u2502      \'selectBusinessNameMatch\'].includes(substep.id)                       \u2502\n\u2502                                                                             \u2502\n\u2502 2. If options empty, call GET /copilot/state                               \u2502\n\u2502 3. Use state.currentSubstepDetails.currentSubstep.options                  \u2502\n\u2502                                                                             \u2502\n\u2502 Prevention:                                                                 \u2502\n\u2502 \u2022 Always fetch fresh state before rendering dynamic substeps               \u2502\n\u2502 \u2022 Don\'t cache options for these substeps                                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Issue: "Cannot edit while in edit flow"                                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Cause: Attempting nested edit                                              \u2502\n\u2502                                                                             \u2502\n\u2502 Symptoms:                                                                   \u2502\n\u2502 \u2022 Error when clicking edit button during active edit                       \u2502\n\u2502 \u2022 state.is_in_edit_flow = true                                             \u2502\n\u2502                                                                             \u2502\n\u2502 Solution:                                                                   \u2502\n\u2502 1. Check state.sessionState.is_in_edit_flow before showing edit button     \u2502\n\u2502 2. Disable all edit buttons when in edit flow                              \u2502\n\u2502 3. Show "Complete current edit first" message                              \u2502\n\u2502                                                                             \u2502\n\u2502 UI Pattern:                                                                 \u2502\n\u2502 {!state.is_in_edit_flow && (                                               \u2502\n\u2502   <button onClick={handleEdit}>Edit</button>                               \u2502\n\u2502 )}                                                                          \u2502\n\u2502                                                                             \u2502\n\u2502 Prevention:                                                                 \u2502\n\u2502 \u2022 Track edit state globally                                                \u2502\n\u2502 \u2022 Show edit context breadcrumb when in edit flow                           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Issue: Team size / channel selection fails with plan error                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Cause: Selection exceeds plan limits                                       \u2502\n\u2502                                                                             \u2502\n\u2502 Symptoms:                                                                   \u2502\n\u2502 \u2022 Error: "Team size requires ORGANISATION plan"                            \u2502\n\u2502 \u2022 Error: "Channel requires addon"                                          \u2502\n\u2502 \u2022 requiresUpgrade: true in error response                                  \u2502\n\u2502                                                                             \u2502\n\u2502 Solution:                                                                   \u2502\n\u2502 1. Don\'t treat as error - this triggers upgrade flow                       \u2502\n\u2502 2. Follow navigation to upgrade substeps                                   \u2502\n\u2502 3. Allow user to upgrade or select smaller option                          \u2502\n\u2502                                                                             \u2502\n\u2502 UI Pattern:                                                                 \u2502\n\u2502 \u2022 Show plan comparison when requiresUpgrade: true                          \u2502\n\u2502 \u2022 Highlight recommended plan                                               \u2502\n\u2502 \u2022 Allow "Choose smaller size" option                                       \u2502\n\u2502                                                                             \u2502\n\u2502 Prevention:                                                                 \u2502\n\u2502 \u2022 Show plan limits in UI before selection                                  \u2502\n\u2502 \u2022 Disable options that exceed plan                                         \u2502\n\u2502 \u2022 Add "Requires [PLAN]" badges to options                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Issue: File upload fails silently or times out                             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Cause: Network issues or validation failure                                \u2502\n\u2502                                                                             \u2502\n\u2502 Symptoms:                                                                   \u2502\n\u2502 \u2022 Upload spinner never completes                                           \u2502\n\u2502 \u2022 No error message shown                                                   \u2502\n\u2502 \u2022 File > 5MB or wrong type                                                 \u2502\n\u2502                                                                             \u2502\n\u2502 Solution:                                                                   \u2502\n\u2502 1. Add client-side validation BEFORE upload:                               \u2502\n\u2502    - File size < 5MB                                                       \u2502\n\u2502    - MIME type in [\'image/png\', \'image/jpeg\', \'image/jpg\', \'image/webp\']  \u2502\n\u2502                                                                             \u2502\n\u2502 2. Add timeout handler:                                                    \u2502\n\u2502    setTimeout(() => {                                                      \u2502\n\u2502      if (uploading) {                                                      \u2502\n\u2502        showError(\'Upload timed out. Please try again.\')                    \u2502\n\u2502        setUploading(false)                                                 \u2502\n\u2502      }                                                                      \u2502\n\u2502    }, 30000) // 30 second timeout                                          \u2502\n\u2502                                                                             \u2502\n\u2502 3. Show progress indicator                                                 \u2502\n\u2502 4. Allow cancel/retry                                                      \u2502\n\u2502                                                                             \u2502\n\u2502 Prevention:                                                                 \u2502\n\u2502 \u2022 Use <input accept="image/*"> attribute                                   \u2502\n\u2502 \u2022 Show file requirements in UI                                             \u2502\n\u2502 \u2022 Validate before initiating upload                                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Issue: Assistant deletion shows "Cannot delete last assistant"             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Cause: Attempting to delete when only one assistant remains                \u2502\n\u2502                                                                             \u2502\n\u2502 Symptoms:                                                                   \u2502\n\u2502 \u2022 Error on DELETE /copilot/assistants/:id                                  \u2502\n\u2502 \u2022 All channels would be left without assistant                             \u2502\n\u2502                                                                             \u2502\n\u2502 Solution:                                                                   \u2502\n\u2502 1. Disable delete button when assistants.length === 1                      \u2502\n\u2502 2. Show tooltip: "At least one assistant required"                         \u2502\n\u2502 3. Suggest "Add assistant first, then delete this one"                     \u2502\n\u2502                                                                             \u2502\n\u2502 UI Pattern:                                                                 \u2502\n\u2502 <button                                                                     \u2502\n\u2502   onClick={() => handleDelete(assistant.id)}                               \u2502\n\u2502   disabled={assistants.length === 1}                                       \u2502\n\u2502   title={assistants.length === 1                                           \u2502\n\u2502     ? "Cannot delete last assistant"                                       \u2502\n\u2502     : "Delete assistant"}                                                  \u2502\n\u2502 >                                                                           \u2502\n\u2502   Delete                                                                    \u2502\n\u2502 </button>                                                                   \u2502\n\u2502                                                                             \u2502\n\u2502 Prevention:                                                                 \u2502\n\u2502 \u2022 Always check count before enabling delete                                \u2502\n\u2502 \u2022 Show count badge: "3 assistants"                                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Issue: Edit returns to wrong position                                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Cause: Return position tracking issue                                      \u2502\n\u2502                                                                             \u2502\n\u2502 Symptoms:                                                                   \u2502\n\u2502 \u2022 After completing edit, navigates to unexpected substep                   \u2502\n\u2502 \u2022 state.edit_return_position seems incorrect                               \u2502\n\u2502                                                                             \u2502\n\u2502 Debug Steps:                                                                \u2502\n\u2502 1. Check state.edit_return_position in GET /copilot/state                  \u2502\n\u2502 2. Verify it matches where edit started                                    \u2502\n\u2502 3. Check edit_history for edit origin                                      \u2502\n\u2502                                                                             \u2502\n\u2502 Solution:                                                                   \u2502\n\u2502 \u2022 This is usually a backend bug, not frontend                              \u2502\n\u2502 \u2022 Log issue with edit flow details                                         \u2502\n\u2502 \u2022 Workaround: Call POST /copilot/restart to reset                          \u2502\n\u2502                                                                             \u2502\n\u2502 Prevention:                                                                 \u2502\n\u2502 \u2022 Track original position in frontend state during edit                    \u2502\n\u2502 \u2022 Validate return position exists before navigation                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Issue: Business search returns no results                                  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Cause: No matching businesses found                                        \u2502\n\u2502                                                                             \u2502\n\u2502 Symptoms:                                                                   \u2502\n\u2502 \u2022 selectBusinessNameMatch shows only "My business isn\'t listed"            \u2502\n\u2502 \u2022 state.collected_data.business_search_results = []                        \u2502\n\u2502                                                                             \u2502\n\u2502 Solution:                                                                   \u2502\n\u2502 \u2022 This is expected behavior, not an error                                  \u2502\n\u2502 \u2022 User should select "My business isn\'t listed"                            \u2502\n\u2502 \u2022 Flow continues to businessNotListed for manual entry                     \u2502\n\u2502                                                                             \u2502\n\u2502 UI Pattern:                                                                 \u2502\n\u2502 {options.length === 1 && (                                                 \u2502\n\u2502   <div>                                                                     \u2502\n\u2502     <p>No matches found for "{businessName}"</p>                           \u2502\n\u2502     <p>Don\'t worry - you can add your details manually.</p>                \u2502\n\u2502   </div>                                                                    \u2502\n\u2502 )}                                                                          \u2502\n\u2502                                                                             \u2502\n\u2502 Prevention:                                                                 \u2502\n\u2502 \u2022 Set user expectations: "We\'ll search for your business"                  \u2502\n\u2502 \u2022 Explain manual entry is always available                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,a.jsx)(n.h2,{id:"testing-scenarios",children:"Testing Scenarios"}),"\n",(0,a.jsx)(n.h3,{id:"unit-test-cases",children:"Unit Test Cases"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Test Suite 1: Normal Flow Navigation\n\ndescribe("Normal Flow Navigation", () => {\n  test("should advance from planConfirmation to businessIndustry", async () => {\n    const response = await sendMessage({\n      inputType: "selection",\n      content: "Yes, Proceed with my current plan",\n      metadata: {\n        substepId: "planConfirmation",\n        selectedOption: true,\n      },\n    });\n\n    expect(response.currentSubstep.id).toBe("businessIndustry");\n    expect(response.currentSubstep.options).toHaveLength(13); // 12 industries + "not listed"\n  });\n\n  test(\'should handle "category not listed" flow\', async () => {\n    const response = await sendMessage({\n      inputType: "selection",\n      content: "Category not listed here",\n      metadata: {\n        substepId: "businessIndustry",\n        selectedOption: "none",\n      },\n    });\n\n    expect(response.currentSubstep.id).toBe("categoryNotListed");\n    expect(response.currentSubstep.type).toBe("input");\n  });\n\n  test("should validate business name input", async () => {\n    await expect(\n      sendMessage({\n        inputType: "text",\n        content: "", // Empty name\n        metadata: { substepId: "businessName" },\n      })\n    ).rejects.toMatchObject({\n      status: 400,\n      message: expect.stringContaining("Business name must be"),\n    });\n  });\n\n  test("should handle empty search results", async () => {\n    // Mock businessLookupService to return []\n    jest.spyOn(businessLookupService, "searchBusiness").mockResolvedValue([]);\n\n    const response = await sendMessage({\n      inputType: "text",\n      content: "Nonexistent Business XYZ",\n      metadata: { substepId: "businessName" },\n    });\n\n    expect(response.currentSubstep.id).toBe("selectBusinessNameMatch");\n    expect(response.currentSubstep.options).toHaveLength(1); // Only "not listed"\n    expect(response.currentSubstep.options[0].isCustom).toBe(true);\n  });\n\n  test("should complete section and advance to next section", async () => {\n    const response = await sendMessage({\n      inputType: "selection",\n      content: "Confirm",\n      metadata: {\n        substepId: "confirmBusinessData",\n        selectedOption: "confirm",\n      },\n    });\n\n    expect(response.sectionComplete).toBe(true);\n    expect(response.currentSubstep.parentStepId).toBe("teamMembers");\n    expect(response.currentSubstep.id).toBe("teamSize");\n  });\n});\n\n// Test Suite 2: Plan Validation\n\ndescribe("Plan Validation", () => {\n  test("should allow team size within plan limit", async () => {\n    // User on BUSINESS plan (max 10 seats)\n    const response = await sendMessage({\n      inputType: "selection",\n      content: "6-20",\n      metadata: {\n        substepId: "teamSize",\n        selectedOption: "6-20",\n      },\n    });\n\n    // Should navigate to upgrade flow (6-20 exceeds 10)\n    expect(response.currentSubstep.id).toBe("teamSizeOverLimit");\n  });\n\n  test("should block channel requiring addon", async () => {\n    // User on STARTER plan (no CRM addon)\n    await expect(\n      sendMessage({\n        inputType: "selection",\n        content: "Google Calendar",\n        metadata: {\n          substepId: "channels",\n          selectedOptions: ["google_calendar"],\n        },\n      })\n    ).rejects.toMatchObject({\n      status: 400,\n      requiresUpgrade: true,\n      details: expect.objectContaining({\n        google_calendar: expect.stringContaining("CRM"),\n      }),\n    });\n  });\n\n  test("should cap AI assistants at plan limit", async () => {\n    // User on BUSINESS plan (max 3 assistants)\n    // Selects "multiple" strategy with 5 channels\n    const response = await sendMessage({\n      inputType: "selection",\n      content: "Multiple Assistants by Channel",\n      metadata: {\n        substepId: "aiAssistantsForChannels",\n        selectedOption: "multiple",\n      },\n    });\n\n    const createdAssistants = response.currentSubstep.botMessage.filter(\n      (m) => m.component === "AssistantCard"\n    );\n\n    expect(createdAssistants).toHaveLength(3); // Capped at plan limit\n  });\n});\n\n// Test Suite 3: Edit Flow\n\ndescribe("Edit Flow", () => {\n  test("should handle same-section inline edit", async () => {\n    const response = await editSubstep("noReplyConfiguration", "escalate");\n\n    expect(response.uiDirectives.editComplete).toBe(true);\n    expect(response.uiDirectives.isInEditFlow).toBe(false);\n    expect(response.currentSubstep.id).toBe("confirmNoReplyConfiguration"); // Unchanged\n  });\n\n  test("should handle cross-section edit with navigation", async () => {\n    // Currently at channels/channels\n    // Edit businessIndustry from earlier section\n    const response = await editSubstep(\n      "businessIndustry",\n      "HEALTHCARE_CLINICS"\n    );\n\n    expect(response.uiDirectives.isInEditFlow).toBe(true);\n    expect(response.uiDirectives.editContext).toMatchObject({\n      editedSubstep: "businessIndustry",\n      editedSection: "businessIdentity",\n      affectedSubsteps: [\n        { substep: "confirmBusinessData", section: "businessIdentity" },\n        { substep: "adjustGoalsObjectives", section: "businessIdentity" },\n      ],\n    });\n    expect(response.currentSubstep.id).toBe("confirmBusinessData");\n  });\n\n  test("should return to origin after completing edit", async () => {\n    // Complete affected substep during edit flow\n    const response = await sendMessage({\n      inputType: "selection",\n      content: "Confirm",\n      metadata: {\n        substepId: "adjustGoalsConfirm", // Last affected substep\n        selectedOption: "confirm",\n      },\n    });\n\n    expect(response.uiDirectives.editComplete).toBe(true);\n    expect(response.uiDirectives.returnedFromEdit).toBe(true);\n    expect(response.currentSubstep.id).toBe("channels"); // Original position\n  });\n\n  test("should block nested edits", async () => {\n    // Start first edit\n    await editSubstep("businessIndustry", "REAL_ESTATE");\n\n    // Attempt second edit while first is active\n    await expect(editSubstep("teamSize", "21")).rejects.toMatchObject({\n      status: 400,\n      message: expect.stringContaining("Cannot edit while in edit flow"),\n    });\n  });\n\n  test("should clear affected substeps and data", async () => {\n    const stateBefore = await getState();\n    expect(stateBefore.sessionState.completed_substeps).toContain(\n      "confirmBusinessData"\n    );\n    expect(\n      stateBefore.sessionState.collected_data.suggested_goals\n    ).toBeTruthy();\n\n    await editSubstep("businessIndustry", "FINANCE_ACCOUNTING");\n\n    const stateAfter = await getState();\n    expect(stateAfter.sessionState.completed_substeps).not.toContain(\n      "confirmBusinessData"\n    );\n    expect(stateAfter.sessionState.collected_data.suggested_goals).toBeNull();\n  });\n\n  test("should record edit in history", async () => {\n    await editSubstep("channels", ["whatsapp", "gmail"]);\n\n    const state = await getState();\n    const lastEdit =\n      state.sessionState.edit_history[\n        state.sessionState.edit_history.length - 1\n      ];\n\n    expect(lastEdit).toMatchObject({\n      section: "channels",\n      substep: "channels",\n      field: "channels",\n      new_value: ["whatsapp", "gmail"],\n    });\n    expect(lastEdit.timestamp).toBeTruthy();\n  });\n});\n\n// Test Suite 4: File Upload\n\ndescribe("File Upload", () => {\n  test("should upload valid logo file", async () => {\n    const file = new File(["fake image data"], "logo.png", {\n      type: "image/png",\n    });\n\n    const response = await uploadLogo(file, "businessNotListed");\n\n    expect(response.currentSubstep.id).toBe("confirmBusinessData");\n    expect(response.uiDirectives.components).toContainEqual(\n      expect.objectContaining({\n        name: "businessLogo",\n        metadata: expect.objectContaining({\n          logoUrl: expect.stringContaining("s3.amazonaws.com"),\n        }),\n      })\n    );\n  });\n\n  test("should reject file over 5MB", async () => {\n    const largeFile = new File(\n      [new ArrayBuffer(6 * 1024 * 1024)],\n      "large.png",\n      {\n        type: "image/png",\n      }\n    );\n\n    await expect(\n      uploadLogo(largeFile, "businessNotListed")\n    ).rejects.toMatchObject({\n      status: 400,\n      message: expect.stringContaining("5MB"),\n    });\n  });\n\n  test("should reject invalid file type", async () => {\n    const pdfFile = new File(["fake pdf"], "doc.pdf", {\n      type: "application/pdf",\n    });\n\n    await expect(\n      uploadLogo(pdfFile, "businessNotListed")\n    ).rejects.toMatchObject({\n      status: 400,\n      message: expect.stringContaining("PNG, JPG"),\n    });\n  });\n});\n\n// Test Suite 5: Assistant Management\n\ndescribe("Assistant Management", () => {\n  test("should add assistant and rebalance channels", async () => {\n    const stateBefore = await getState();\n    const initialCount =\n      stateBefore.sessionState.collected_data.created_assistants.length;\n\n    const response = await addAssistant();\n\n    const createdAssistants = response.currentSubstep.botMessage.filter(\n      (m) => m.component === "AssistantCard"\n    );\n    expect(createdAssistants).toHaveLength(initialCount + 1);\n\n    // Verify channel configs updated\n    const stateAfter = await getState();\n    expect(\n      stateAfter.sessionState.collected_data.draft_channel_configs\n    ).toBeTruthy();\n  });\n\n  test("should delete assistant and reassign channels", async () => {\n    const state = await getState();\n    const assistantToDelete =\n      state.sessionState.collected_data.created_assistants[1];\n\n    const response = await deleteAssistant(assistantToDelete.id);\n\n    const remainingAssistants = response.currentSubstep.botMessage.filter(\n      (m) => m.component === "AssistantCard"\n    );\n    expect(remainingAssistants).not.toContainEqual(\n      expect.objectContaining({ metadata: { id: assistantToDelete.id } })\n    );\n  });\n\n  test("should prevent deleting last assistant", async () => {\n    // Delete all but one\n    const state = await getState();\n    const assistants = state.sessionState.collected_data.created_assistants;\n\n    for (let i = 1; i < assistants.length; i++) {\n      await deleteAssistant(assistants[i].id);\n    }\n\n    // Attempt to delete last one\n    await expect(deleteAssistant(assistants[0].id)).rejects.toMatchObject({\n      status: 400,\n      message: expect.stringContaining("Cannot delete the last"),\n    });\n  });\n});\n\n// Test Suite 6: State Synchronization\n\ndescribe("State Synchronization", () => {\n  test("should reject message with mismatched substepId", async () => {\n    const state = await getState();\n\n    await expect(\n      sendMessage({\n        inputType: "selection",\n        content: "Test",\n        metadata: {\n          substepId: "wrongSubstep", // Doesn\'t match current position\n        },\n      })\n    ).rejects.toMatchObject({\n      status: 400,\n      hint: expect.stringContaining("call GET /copilot/state"),\n    });\n  });\n\n  test("should persist state across GET requests", async () => {\n    const state1 = await getState();\n    const state2 = await getState();\n\n    expect(state1.conversationId).toBe(state2.conversationId);\n    expect(state1.currentSubstep.id).toBe(state2.currentSubstep.id);\n    expect(state1.sessionState.collected_data).toEqual(\n      state2.sessionState.collected_data\n    );\n  });\n\n  test("should handle conversation restart", async () => {\n    const stateBefore = await getState();\n\n    const response = await restartConversation();\n\n    expect(response.currentSubstep.id).toBe("planConfirmation"); // First substep\n\n    const stateAfter = await getState();\n    expect(stateAfter.conversationId).not.toBe(stateBefore.conversationId);\n    expect(stateAfter.sessionState.completed_substeps).toHaveLength(0);\n  });\n});\n'})}),"\n",(0,a.jsx)(n.h3,{id:"integration-test-scenarios",children:"Integration Test Scenarios"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-typescript",children:'// Scenario 1: Complete Happy Path (No Edits)\n\ntest("should complete full onboarding flow", async () => {\n  // 1. Start conversation\n  const start = await POST("/copilot/start");\n  expect(start.currentSubstep.id).toBe("planConfirmation");\n\n  // 2. Confirm plan\n  const confirmPlan = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "Yes, Proceed with my current plan",\n    metadata: { substepId: "planConfirmation", selectedOption: true },\n  });\n  expect(confirmPlan.currentSubstep.id).toBe("businessIndustry");\n\n  // 3. Select industry\n  const selectIndustry = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "E-commerce / Retail",\n    metadata: {\n      substepId: "businessIndustry",\n      selectedOption: "ECOMMERCE_RETAIL",\n    },\n  });\n  expect(selectIndustry.currentSubstep.id).toBe("businessName");\n\n  // 4. Enter business name\n  const enterName = await POST("/copilot/message", {\n    inputType: "text",\n    content: "Acme Corp",\n    metadata: { substepId: "businessName" },\n  });\n  expect(enterName.currentSubstep.id).toBe("selectBusinessNameMatch");\n\n  // 5. Select business match\n  const selectMatch = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "Acme Corp Ltd",\n    metadata: {\n      substepId: "selectBusinessNameMatch",\n      selectedOption: enterName.currentSubstep.options[0].value,\n    },\n  });\n  expect(selectMatch.currentSubstep.id).toBe("confirmBusinessData");\n\n  // 6. Confirm business data\n  const confirmBusiness = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "Confirm",\n    metadata: { substepId: "confirmBusinessData", selectedOption: "confirm" },\n  });\n  expect(confirmBusiness.sectionComplete).toBe(true);\n  expect(confirmBusiness.currentSubstep.parentStepId).toBe("teamMembers");\n\n  // ... continue through remaining sections\n\n  // Final: Complete automation\n  const complete = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "Confirm and continue",\n    metadata: { substepId: "finalizeSetup", selectedOption: true },\n  });\n  expect(complete.conversationComplete).toBe(true);\n  expect(complete.currentSubstep).toBeNull();\n});\n\n// Scenario 2: Cross-Section Edit with Return\n\ntest("should handle cross-section edit and return", async () => {\n  // Complete through channels section\n  // ... (omitted for brevity)\n\n  const stateBeforeEdit = await GET("/copilot/state");\n  expect(stateBeforeEdit.currentSection).toBe("channels");\n  expect(stateBeforeEdit.currentSubstep).toBe("confirmChannelsConfiguration");\n\n  // Edit businessIndustry from earlier section\n  const edit = await POST("/copilot/edit/businessIndustry", {\n    substepId: "businessIndustry",\n    newValue: "HEALTHCARE_CLINICS",\n  });\n\n  expect(edit.uiDirectives.isInEditFlow).toBe(true);\n  expect(edit.currentSubstep.id).toBe("confirmBusinessData");\n\n  // Complete affected substeps\n  const confirmEdited = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "Confirm",\n    metadata: { substepId: "confirmBusinessData", selectedOption: "confirm" },\n  });\n\n  // Should return to original position\n  expect(confirmEdited.uiDirectives.returnedFromEdit).toBe(true);\n  expect(confirmEdited.currentSubstep.id).toBe("confirmChannelsConfiguration");\n\n  const stateAfterReturn = await GET("/copilot/state");\n  expect(stateAfterReturn.sessionState.is_in_edit_flow).toBe(false);\n  expect(stateAfterReturn.sessionState.edit_return_position).toBeNull();\n});\n\n// Scenario 3: Plan Upgrade Flow\n\ntest("should handle team size exceeding plan limit", async () => {\n  // User on BUSINESS plan (max 10 seats)\n\n  const selectLargeTeam = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "21 or more",\n    metadata: { substepId: "teamSize", selectedOption: "21" },\n  });\n\n  // Should navigate to upgrade flow\n  expect(selectLargeTeam.currentSubstep.id).toBe("teamSizeOverLimit");\n\n  // Select upgrade option\n  const chooseUpgrade = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "Upgrade my plan",\n    metadata: { substepId: "teamSizeOverLimit", selectedOption: "upgrade" },\n  });\n  expect(chooseUpgrade.currentSubstep.id).toBe("teamUpgradeOptions");\n\n  // Select ORGANISATION plan\n  const selectPlan = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "ORGANISATION",\n    metadata: {\n      substepId: "teamUpgradeOptions",\n      selectedOption: "ORGANISATION",\n    },\n  });\n  expect(selectPlan.currentSubstep.id).toBe("teamUpgradeConfirm");\n\n  // Confirm upgrade\n  const confirmUpgrade = await POST("/copilot/message", {\n    inputType: "selection",\n    content: "Continue",\n    metadata: { substepId: "teamUpgradeConfirm", selectedOption: true },\n  });\n\n  // Should advance to next section\n  expect(confirmUpgrade.currentSubstep.parentStepId).toBe("channels");\n\n  // Verify plan changed\n  const state = await GET("/copilot/state");\n  expect(state.sessionState.collected_data.selected_plan).toBe("ORGANISATION");\n  expect(state.sessionState.collected_data.team_size).toBe("21");\n});\n'})}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Phase 3 Complete: Supplementary Documentation"})}),"\n",(0,a.jsx)(n.p,{children:"This phase covered:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u2705 Comprehensive edge cases matrix (50+ scenarios)"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Production-ready code examples (6 complete patterns)"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Troubleshooting guide (8 common issues with solutions)"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Testing scenarios (unit tests + integration tests)"}),"\n"]}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h2,{id:"complete-documentation-summary",children:"Complete Documentation Summary"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Phase 1: Normal Flow Documentation"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u2705 Section A: API Reference - All endpoints, request/response schemas, validation rules"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Section B: Flow Logic - Navigation, state management, validation chains, special flows"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Phase 2: Edit Flow Documentation"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u2705 Section A: Edit API Reference - Edit endpoints, value types, response patterns"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Section B: Edit State Management - Context lifecycle, impact chains, return flow, cleanup"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Phase 3: Supplementary Documentation"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u2705 Edge cases matrix - 50+ scenarios with handling patterns"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Code examples - 6 production-ready integration snippets"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Troubleshooting guide - 8 common issues with solutions"}),"\n",(0,a.jsx)(n.li,{children:"\u2705 Testing scenarios - Comprehensive unit and integration tests"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Total Coverage:"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"10+ API endpoints documented"}),"\n",(0,a.jsx)(n.li,{children:"40+ substeps covered"}),"\n",(0,a.jsx)(n.li,{children:"50+ edge cases catalogued"}),"\n",(0,a.jsx)(n.li,{children:"20+ code examples provided"}),"\n",(0,a.jsx)(n.li,{children:"7-phase validation system explained"}),"\n",(0,a.jsx)(n.li,{children:"Complete state management patterns"}),"\n",(0,a.jsx)(n.li,{children:"Full edit flow lifecycle"}),"\n",(0,a.jsx)(n.li,{children:"Production-ready testing suite"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This documentation enables frontend developers to integrate the copilot system without requiring backend knowledge, handle all edge cases gracefully, and build a production-ready implementation."})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var s=t(6540);const a={},i=s.createContext(a);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);